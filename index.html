<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H4Rent Management</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM for UI -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDKs (Compat version for easier browser usage) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles from the original app */
        .input-form { 
            display: block; 
            width: 100%; 
            padding: 0.5rem 0.75rem; 
            font-size: 1rem; 
            line-height: 1.5; 
            color: #495057; 
            background-color: #fff; 
            background-clip: padding-box; 
            border: 1px solid #ced4da; 
            border-radius: 0.375rem; 
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out; 
        }
        .input-form:focus { 
            color: #495057; 
            background-color: #fff; 
            border-color: #80bdff; 
            outline: 0; 
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); 
        }
        .btn-primary { 
            color: #fff; 
            background-color: #007bff; 
            border-color: #007bff; 
            padding: 0.5rem 1rem; 
            font-size: 1rem; 
            border-radius: 0.375rem; 
            cursor: pointer; 
            font-weight: bold; 
            transition: background-color 0.2s; 
        }
        .btn-primary:hover { 
            background-color: #0056b3; 
        }
        .btn-secondary { 
            color: #fff; 
            background-color: #6c757d; 
            border-color: #6c757d; 
            padding: 0.25rem 0.5rem; 
            font-size: 0.875rem; 
            border-radius: 0.25rem; 
            cursor: pointer; 
            font-weight: bold; 
            transition: background-color 0.2s; 
        }
        .btn-secondary:hover { 
            background-color: #5a6268; 
        }
    </style>
</head>
<body>
    <!-- The root element where the React app will be mounted -->
    <div id="root"></div>

    <!-- The React application code, transpiled by Babel -->
    <script type="text/babel">
        // --- DESTRUCTURE REACT HOOKS FROM GLOBAL React OBJECT ---
        const { useState, useEffect, useMemo, useRef } = React;

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCOofbN91yeOEWeAIP6wHgtGBfLZi9qJ1Y",
            authDomain: "h4rent-c12ef.firebaseapp.com",
            projectId: "h4rent-c12ef",
            storageBucket: "h4rent-c12ef.appspot.com",
            messagingSenderId: "860501720608",
            appId: "1:860501720608:web:d6a81ae6aeba099c72c645"
        };

        // --- INITIALIZE FIREBASE USING COMPAT LIBRARIES ---
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const { Timestamp } = firebase.firestore;

        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN').format(amount);
        const formatDate = (date) => {
            if (!date) return 'N/A';
            const jsDate = date.toDate ? date.toDate() : new Date(date);
            return jsDate.toLocaleDateString('vi-VN');
        };

        // --- CHART COMPONENTS ---
        const FinanceColumnChart = ({ chartData }) => {
            const chartRef = useRef(null);
            const chartInstanceRef = useRef(null);

            useEffect(() => {
                if (chartInstanceRef.current) {
                    chartInstanceRef.current.destroy();
                }
                if (!chartRef.current || !chartData) return;

                const myChartRef = chartRef.current.getContext("2d");
                
                chartInstanceRef.current = new Chart(myChartRef, {
                    type: "bar",
                    data: {
                        labels: chartData.labels,
                        datasets: [
                            {
                                label: "Doanh thu",
                                data: chartData.revenueData,
                                backgroundColor: "rgba(54, 162, 235, 0.6)",
                                borderColor: "rgba(54, 162, 235, 1)",
                                borderWidth: 1,
                            },
                            {
                                label: "Chi phí",
                                data: chartData.expenseData,
                                backgroundColor: "rgba(255, 99, 132, 0.6)",
                                borderColor: "rgba(255, 99, 132, 1)",
                                borderWidth: 1,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.destroy();
                    }
                }
            }, [chartData]);

            return <div style={{height: '300px'}}><canvas ref={chartRef} /></div>;
        };

        const ExpensePieChart = ({ chartData }) => {
            const chartRef = useRef(null);
            const chartInstanceRef = useRef(null);

            useEffect(() => {
                if (chartInstanceRef.current) {
                    chartInstanceRef.current.destroy();
                }
                 if (!chartRef.current || !chartData || chartData.data.length === 0) return;

                const myChartRef = chartRef.current.getContext("2d");
                
                chartInstanceRef.current = new Chart(myChartRef, {
                    type: "pie",
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            data: chartData.data,
                             backgroundColor: [
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 206, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)',
                                'rgba(255, 159, 64, 0.8)'
                            ],
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += formatCurrency(context.parsed) + ' VNĐ';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.destroy();
                    }
                }
            }, [chartData]);

            return <div style={{height: '300px'}}><canvas ref={chartRef} /></div>;
        };


        // --- MAIN UI COMPONENTS ---

        const LoginScreen = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (err) {
                    setError('Email hoặc mật khẩu không đúng. Vui lòng thử lại.');
                    console.error("Lỗi đăng nhập:", err);
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
                        <h1 className="text-2xl font-bold text-center text-gray-800 mb-6">Đăng Nhập Quản Trị</h1>
                        <form onSubmit={handleLogin}>
                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="email">Email</label>
                                <input id="email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="input-form" placeholder="admin@example.com" required />
                            </div>
                            <div className="mb-6">
                                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">Mật khẩu</label>
                                <input id="password" type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="input-form" placeholder="******************" required />
                            </div>
                            {error && (
                                <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                                    <span className="block sm:inline">{error}</span>
                                </div>
                            )}
                            <button type="submit" className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">Đăng Nhập</button>
                        </form>
                    </div>
                </div>
            );
        };

        const Modal = ({ show, onClose, title, children }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-lg">
                        <div className="p-4 border-b flex justify-between items-center">
                            <h3 className="text-xl font-semibold">{title}</h3>
                            <button onClick={onClose} className="text-black text-2xl font-bold">&times;</button>
                        </div>
                        <div className="p-4 max-h-[80vh] overflow-y-auto">{children}</div>
                    </div>
                </div>
            );
        };

        const ConfirmationModal = ({ show, onClose, onConfirm, title, message }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-sm">
                        <div className="p-6">
                            <h3 className="text-xl font-bold text-gray-900">{title}</h3>
                            <p className="mt-2 text-sm text-gray-600">{message}</p>
                        </div>
                        <div className="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                            <button type="button" onClick={onConfirm} className="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">Xóa</button>
                            <button type="button" onClick={onClose} className="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">Hủy</button>
                        </div>
                    </div>
                </div>
            );
        };

        const BottomSheet = ({ show, onClose, title, data, type, onOpenContractModal }) => {
            const [openBuildingName, setOpenBuildingName] = useState(null);

            const toggleBuilding = (buildingName) => {
                setOpenBuildingName(prev => (prev === buildingName ? null : buildingName));
            };

            const isBedList = ['available', 'occupied', 'total'].includes(type);

            const groupedData = useMemo(() => {
                if (!isBedList) return [];
                const groups = data.reduce((acc, item) => {
                    const key = item.buildingName || 'Chưa xác định';
                    if (!acc[key]) {
                        acc[key] = [];
                    }
                    acc[key].push(item);
                    return acc;
                }, {});
                return Object.entries(groups).map(([buildingName, items]) => ({
                    buildingName,
                    items
                }));
            }, [data, isBedList]);

            return (
                <div className={`fixed inset-0 bg-black bg-opacity-50 z-50 transition-opacity duration-300 ${show ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={onClose}>
                    <div className={`fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-2xl transform transition-transform duration-300 ease-out ${show ? 'translate-y-0' : 'translate-y-full'}`} onClick={(e) => e.stopPropagation()}>
                        <div className="p-4 border-b">
                            <div className="flex justify-between items-center"><h3 className="text-xl font-semibold">{title}</h3><button onClick={onClose} className="text-gray-500 text-2xl font-bold">&times;</button></div>
                        </div>
                        <div className="p-4 max-h-[60vh] overflow-y-auto">
                            {isBedList ? (
                                <div className="space-y-2">
                                    {groupedData.map(group => (
                                        <div key={group.buildingName} className="border rounded-lg overflow-hidden">
                                            <button onClick={() => toggleBuilding(group.buildingName)} className="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 focus:outline-none flex justify-between items-center transition">
                                                <h4 className="font-bold text-lg text-gray-800">{group.buildingName} ({group.items.length})</h4>
                                                <span className={`transform transition-transform duration-300 ${openBuildingName === group.buildingName ? 'rotate-180' : ''}`}>
                                                    <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                                                </span>
                                            </button>
                                            {openBuildingName === group.buildingName && (
                                                <ul className="space-y-2 mt-2 p-3 border-t">
                                                    {group.items.map(item => (
                                                        <li key={item.id} className="p-3 bg-gray-50 rounded-lg flex justify-between items-center">
                                                            <div>
                                                                <p className="font-bold">{item.name}</p>
                                                                <p className="text-sm text-gray-600">{item.roomName || 'Phòng không xác định'}</p>
                                                            </div>
                                                            {type === 'available' && (
                                                                <button onClick={() => onOpenContractModal(item)} className="btn-secondary text-xs">Tạo HĐ</button>
                                                            )}
                                                        </li>
                                                    ))}
                                                </ul>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <ul className="space-y-3">
                                    {data.map(c => { 
                                        const tenantInfo = tenants.find(t => t.id === c.tenantId); 
                                        return (<li key={c.id} className="p-3 bg-gray-100 rounded-lg"><p className="font-bold">{tenantInfo?.name || 'Không rõ'}</p><p className="text-sm text-gray-600">Hết hạn: {formatDate(c.endDate)}</p></li>)
                                    })}
                                </ul>
                            )}
                            {data.length === 0 && <p className="text-gray-500 text-center py-4">Không có dữ liệu.</p>}
                        </div>
                    </div>
                </div>
            );
        };

        const StatCard = ({ title, value, subtext, colorClass, onClick, children }) => (
            <div 
                className={`p-6 rounded-lg shadow-lg text-white ${colorClass} transition-all duration-300 ease-in-out ${onClick ? 'cursor-pointer hover:scale-105 hover:shadow-xl' : ''}`} 
                onClick={onClick}
            >
                {children ? children : (
                    <>
                        <p className="text-lg font-semibold">{title}</p>
                        <p className="text-4xl font-bold">{value}</p>
                        <p className="text-sm opacity-80">{subtext}</p>
                    </>
                )}
            </div>
        );

        const Dashboard = ({ allBeds, tenants, contracts, payments, buildingsData, onUpdatePaymentStatus, onOpenContractModal }) => {
            const [bottomSheet, setBottomSheet] = useState({ show: false, title: '', data: [], type: '' });

            const stats = useMemo(() => {
                const totalBuildings = buildingsData.length;
                const totalBeds = allBeds.length;
                const occupiedBeds = allBeds.filter(b => b.status === 'occupied').length;
                const availableBeds = totalBeds - occupiedBeds;
                return { totalBuildings, totalBeds, occupiedBeds, availableBeds };
            }, [allBeds, buildingsData]);

            const expiringContracts = useMemo(() => {
                const now = new Date();
                const thirtyDaysFromNow = new Date();
                thirtyDaysFromNow.setDate(now.getDate() + 30);
                return contracts.map(c => { 
                    const startDate = c.startDate.toDate(); 
                    const endDate = new Date(startDate); 
                    endDate.setMonth(startDate.getMonth() + parseInt(c.paymentCycle)); 
                    return { ...c, endDate }; 
                }).filter(c => c.endDate > now && c.endDate <= thirtyDaysFromNow);
            }, [contracts]);

            const handleStatCardClick = (type) => {
                let title = ''; let data = [];
                switch (type) {
                    case 'occupied': title = 'Giường đã thuê'; data = allBeds.filter(b => b.status === 'occupied'); break;
                    case 'available': title = 'Giường còn trống'; data = allBeds.filter(b => b.status === 'available'); break;
                    case 'expiring': title = 'Hợp đồng sắp hết hạn'; data = expiringContracts; break;
                    default: return;
                }
                setBottomSheet({ show: true, title, data, type });
            };

            return (
                <>
                    <div className="p-4 md:p-8 space-y-8">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <StatCard title="Tổng Quan Hệ Thống" colorClass="bg-purple-500">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <p className="text-lg font-semibold">Số nhà</p>
                                        <p className="text-4xl font-bold">{stats.totalBuildings}</p>
                                    </div>
                                    <div className="border-l-2 border-purple-400 h-16 mx-4"></div>
                                    <div>
                                        <p className="text-lg font-semibold">Số giường</p>
                                        <p className="text-4xl font-bold">{stats.totalBeds}</p>
                                    </div>
                                </div>
                            </StatCard>
                            <StatCard title="Giường còn trống" value={stats.availableBeds} subtext="Sẵn sàng cho thuê" colorClass="bg-yellow-500" onClick={() => handleStatCardClick('available')} />
                            <StatCard title="Giường đã thuê" value={stats.occupiedBeds} subtext={`${stats.totalBeds > 0 ? ((stats.occupiedBeds / stats.totalBeds) * 100).toFixed(1) : 0}% lấp đầy`} colorClass="bg-green-500" onClick={() => handleStatCardClick('occupied')} />
                            <StatCard title="Hợp đồng sắp hết hạn" value={expiringContracts.length} subtext="Trong 30 ngày tới" colorClass="bg-red-500" onClick={() => handleStatCardClick('expiring')} />
                        </div>
                        <div className="bg-white p-6 rounded-lg shadow">
                            <h2 className="text-xl font-semibold mb-4 border-b pb-2">Các Khoản Cần Thu</h2>
                            <ul className="space-y-3 max-h-96 overflow-y-auto">
                                {payments.filter(p => p.status === 'unpaid').map(p => { const tenantInfo = tenants.find(t => t.id === p.tenantId); return (<li key={p.id} className="p-3 bg-yellow-100 rounded-lg"><p className="font-bold">{tenantInfo?.name || 'Không rõ'}</p><p className="text-lg text-yellow-800 font-semibold">{formatCurrency(p.amount)} VNĐ</p><button onClick={() => onUpdatePaymentStatus(p.id, 'paid')} className="mt-2 w-full btn-primary bg-green-500 hover:bg-green-700">Xác Nhận Đã Thanh Toán</button></li>); })}
                                {payments.filter(p => p.status === 'unpaid').length === 0 && <p className="text-gray-500">Không có khoản thu nào.</p>}
                            </ul>
                        </div>
                    </div>
                    <BottomSheet 
                        show={bottomSheet.show} 
                        onClose={() => setBottomSheet({ ...bottomSheet, show: false })} 
                        title={bottomSheet.title} 
                        data={bottomSheet.data} 
                        type={bottomSheet.type} 
                        onOpenContractModal={(bed) => {
                            onOpenContractModal(bed);
                            setBottomSheet({ ...bottomSheet, show: false });
                        }}
                    />
                </>
            );
        };

        const TenantDirectory = ({ allBeds, tenantsData, buildingsData }) => {
            const [openBuildingId, setOpenBuildingId] = useState(null);

            const directoryData = useMemo(() => {
                const tenantsMap = new Map(tenantsData.map(t => [t.id, t]));
                const buildingsMap = new Map();

                allBeds.forEach(bed => {
                    if (!bed.buildingName || !bed.roomName) return;

                    if (!buildingsMap.has(bed.buildingName)) {
                        const buildingInfo = buildingsData.find(b => b.name === bed.buildingName);
                        buildingsMap.set(bed.buildingName, {
                            id: buildingInfo?.id || bed.buildingName,
                            name: bed.buildingName,
                            rooms: new Map()
                        });
                    }
                    const building = buildingsMap.get(bed.buildingName);

                    if (!building.rooms.has(bed.roomName)) {
                        building.rooms.set(bed.roomName, {
                            id: bed.roomId || `${building.id}_${bed.roomName}`,
                            name: bed.roomName,
                            beds: []
                        });
                    }
                    const room = building.rooms.get(bed.roomName);

                    room.beds.push({
                        ...bed,
                        tenant: bed.tenantId ? tenantsMap.get(bed.tenantId) : null
                    });
                });

                return Array.from(buildingsMap.values()).map(building => ({
                    ...building,
                    rooms: Array.from(building.rooms.values()).sort((a, b) => a.name.localeCompare(b.name))
                }));
            }, [allBeds, tenantsData, buildingsData]);

            const toggleBuilding = (buildingId) => {
                setOpenBuildingId(prevId => (prevId === buildingId ? null : buildingId));
            };

            if (directoryData.length === 0) {
                return <div className="p-8 text-center text-gray-500">Không có dữ liệu để hiển thị.</div>;
            }

            return (
                <div className="p-4 md:p-8 space-y-4">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Danh Bạ Người Thuê Theo Tòa Nhà</h2>
                    {directoryData.map(building => (
                        <div key={building.id} className="bg-white rounded-lg shadow overflow-hidden">
                            <button onClick={() => toggleBuilding(building.id)} className="w-full text-left p-4 bg-gray-50 hover:bg-gray-100 focus:outline-none flex justify-between items-center transition">
                                <h3 className="text-xl font-semibold text-gray-800">{building.name}</h3>
                                <span className={`transform transition-transform duration-300 ${openBuildingId === building.id ? 'rotate-180' : ''}`}>
                                    <svg className="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                                </span>
                            </button>
                            {openBuildingId === building.id && (
                                <div className="p-4 space-y-4 border-t">
                                    {building.rooms.map(room => (
                                        <div key={room.id} className="border rounded-lg p-4 bg-gray-50/50">
                                            <h4 className="text-lg font-bold mb-3 text-blue-700">Phòng: {room.name}</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                {room.beds.sort((a,b) => a.name.localeCompare(b.name)).map(bed => (
                                                    <div key={bed.id} className={`p-4 rounded-lg border ${bed.status === 'occupied' ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200'}`}>
                                                        <p className="font-bold text-gray-800">Giường: {bed.name}</p>
                                                        {bed.status === 'occupied' && bed.tenant ? (
                                                            <div className="mt-2 text-sm space-y-1 text-gray-700">
                                                                <p><span className="font-semibold">Người thuê:</span> {bed.tenant.name}</p>
                                                                <p><span className="font-semibold">SĐT:</span> {bed.tenant.phone}</p>
                                                                <p><span className="font-semibold">CCCD:</span> {bed.tenant.idCard || 'N/A'}</p>
                                                                <p><span className="font-semibold">Trường/Việc:</span> {bed.tenant.school || 'N/A'}</p>
                                                            </div>
                                                        ) : (
                                                            <p className="mt-2 text-sm text-yellow-800 font-semibold">Trạng thái: Trống</p>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            );
        };

        const FinanceManagement = ({ buildingsData, expensesData, paymentsData, tenantsData, onAddExpense, onDeleteExpense }) => {
            const expenseCategories = ["Tiền thuê nhà", "Tiền điện", "Tiền nước", "Tiền Internet", "Sửa chữa", "Phí vệ sinh", "Khác"];
            const [newExpense, setNewExpense] = useState({ 
                category: expenseCategories[0], 
                description: '', 
                amount: '', 
                buildingId: '', 
                date: new Date().toISOString().slice(0, 10) 
            });
            const [filter, setFilter] = useState({ buildingId: 'all', startDate: '', endDate: '' });

            const handleAddExpense = (e) => {
                e.preventDefault();
                if (!newExpense.category || !newExpense.amount || !newExpense.buildingId || !newExpense.date) {
                    alert("Vui lòng điền đầy đủ thông tin.");
                    return;
                }
                if (newExpense.category === 'Khác' && !newExpense.description) {
                    alert("Vui lòng nhập nội dung chi tiết cho mục 'Khác'.");
                    return;
                }
                onAddExpense({
                    ...newExpense,
                    amount: parseInt(newExpense.amount, 10),
                    date: Timestamp.fromDate(new Date(newExpense.date))
                });
                setNewExpense({ category: expenseCategories[0], description: '', amount: '', buildingId: '', date: new Date().toISOString().slice(0, 10) });
            };

            const filteredFinancials = useMemo(() => {
                let filteredPayments = paymentsData.filter(p => p.status === 'paid');
                let filteredExpenses = [...expensesData];

                // Filter by Building
                if (filter.buildingId !== 'all') {
                    filteredPayments = filteredPayments.filter(p => p.buildingId === filter.buildingId);
                    filteredExpenses = filteredExpenses.filter(e => e.buildingId === filter.buildingId);
                }

                // Filter by Date
                const start = filter.startDate ? new Date(filter.startDate) : null;
                const end = filter.endDate ? new Date(filter.endDate) : null;
                if(start) start.setHours(0,0,0,0);
                if(end) end.setHours(23,59,59,999);

                if (start) {
                    filteredPayments = filteredPayments.filter(p => p.dueDate.toDate() >= start);
                    filteredExpenses = filteredExpenses.filter(e => e.date.toDate() >= start);
                }
                if (end) {
                    filteredPayments = filteredPayments.filter(p => p.dueDate.toDate() <= end);
                    filteredExpenses = filteredExpenses.filter(e => e.date.toDate() <= end);
                }

                const totalRevenue = filteredPayments.reduce((sum, p) => sum + p.amount, 0);
                const totalExpense = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
                
                const combined = [
                    ...filteredPayments.map(p => ({ ...p, type: 'revenue', date: p.dueDate || p.startDate })),
                    ...filteredExpenses.map(e => ({...e, type: 'expense'}))
                ];
                const transactions = combined.sort((a, b) => b.date.toDate() - a.date.toDate());

                return { totalRevenue, totalExpense, transactions };

            }, [paymentsData, expensesData, filter]);
            
            const chartData = useMemo(() => {
                const monthlyData = {}; 
                const categoryData = {};

                filteredFinancials.transactions.forEach(t => {
                    const month = t.date.toDate().toISOString().slice(0, 7);
                    if (!monthlyData[month]) {
                        monthlyData[month] = { revenue: 0, expense: 0 };
                    }
                    if (t.type === 'revenue') {
                        monthlyData[month].revenue += t.amount;
                    } else {
                        monthlyData[month].expense += t.amount;
                        const category = t.category === 'Khác' && t.description ? t.description : t.category;
                        categoryData[category] = (categoryData[category] || 0) + t.amount;
                    }
                });

                const sortedMonths = Object.keys(monthlyData).sort();
                const columnChartLabels = sortedMonths.map(m => `Tháng ${parseInt(m.slice(5), 10)}/${m.slice(0, 4)}`);
                const revenueData = sortedMonths.map(m => monthlyData[m].revenue);
                const expenseData = sortedMonths.map(m => monthlyData[m].expense);

                const pieChartLabels = Object.keys(categoryData);
                const pieChartData = Object.values(categoryData);

                return {
                    column: { labels: columnChartLabels, revenueData, expenseData },
                    pie: { labels: pieChartLabels, data: pieChartData }
                };
            }, [filteredFinancials]);

            return (
                <div className="p-4 md:p-8 space-y-8">
                    <h2 className="text-2xl font-bold text-gray-800">Quản Lý Tài Chính</h2>
                    
                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="text-xl font-semibold mb-4">Bộ lọc Báo cáo</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Tòa nhà</label>
                                <select value={filter.buildingId} onChange={e => setFilter({...filter, buildingId: e.target.value})} className="input-form mt-1">
                                    <option value="all">Tất cả các nhà</option>
                                    {buildingsData.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}
                                </select>
                            </div>
                            <div className="lg:col-span-2">
                                <label className="block text-sm font-medium text-gray-700">Khoảng thời gian</label>
                                <div className="flex flex-col sm:flex-row gap-2 mt-1">
                                    <input type="date" value={filter.startDate} onChange={e => setFilter({...filter, startDate: e.target.value})} className="input-form"/>
                                    <input type="date" value={filter.endDate} onChange={e => setFilter({...filter, endDate: e.target.value})} className="input-form"/>
                                    <button onClick={() => setFilter({ buildingId: 'all', startDate: '', endDate: '' })} className="btn-secondary whitespace-nowrap">Xóa Lọc</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="p-6 rounded-lg shadow-lg text-white bg-green-500">
                            <p className="text-lg font-semibold">Tổng Doanh Thu</p>
                            <p className="text-4xl font-bold">{formatCurrency(filteredFinancials.totalRevenue)} VNĐ</p>
                            <p className="text-sm opacity-80">Trong khoảng thời gian đã lọc</p>
                        </div>
                        <div className="p-6 rounded-lg shadow-lg text-white bg-red-500">
                            <p className="text-lg font-semibold">Tổng Chi Phí</p>
                            <p className="text-4xl font-bold">{formatCurrency(filteredFinancials.totalExpense)} VNĐ</p>
                            <p className="text-sm opacity-80">Trong khoảng thời gian đã lọc</p>
                        </div>
                        <div className="p-6 rounded-lg shadow-lg text-white bg-blue-500">
                            <p className="text-lg font-semibold">Lợi Nhuận Ước Tính</p>
                            <p className="text-4xl font-bold">{formatCurrency(filteredFinancials.totalRevenue - filteredFinancials.totalExpense)} VNĐ</p>
                            <p className="text-sm opacity-80">Doanh thu - Chi phí</p>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="text-xl font-semibold mb-4">Biểu đồ Phân tích</h3>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div>
                                <h4 className="text-lg font-semibold text-center mb-2">Doanh thu vs. Chi phí</h4>
                                <FinanceColumnChart chartData={chartData.column} />
                            </div>
                            <div>
                                <h4 className="text-lg font-semibold text-center mb-2">Cơ cấu Chi phí</h4>
                                <ExpensePieChart chartData={chartData.pie} />
                            </div>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="text-xl font-semibold mb-4">Thêm Chi Phí Mới</h3>
                        <form onSubmit={handleAddExpense} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Hạng mục chi</label>
                                <select value={newExpense.category} onChange={e => setNewExpense({...newExpense, category: e.target.value, description: ''})} className="input-form mt-1" required>
                                    {expenseCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                </select>
                            </div>
                            {newExpense.category === 'Khác' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">Mô tả chi tiết</label>
                                    <input type="text" value={newExpense.description} onChange={e => setNewExpense({...newExpense, description: e.target.value})} placeholder="VD: Mua chổi lau nhà" className="input-form mt-1" required />
                                </div>
                            )}
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Số tiền (VNĐ)</label>
                                <input type="number" value={newExpense.amount} onChange={e => setNewExpense({...newExpense, amount: e.target.value})} placeholder="2000000" className="input-form mt-1" required />
                            </div>
                             <div>
                                <label className="block text-sm font-medium text-gray-700">Ngày chi</label>
                                <input type="date" value={newExpense.date} onChange={e => setNewExpense({...newExpense, date: e.target.value})} className="input-form mt-1" required />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Cho tòa nhà</label>
                                <select value={newExpense.buildingId} onChange={e => setNewExpense({...newExpense, buildingId: e.target.value})} className="input-form mt-1" required>
                                    <option value="">-- Chọn tòa nhà --</option>
                                    {buildingsData.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}
                                </select>
                            </div>
                            <div className="lg:col-span-2">
                                <button type="submit" className="btn-primary w-full">Thêm Chi Phí</button>
                            </div>
                        </form>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="text-xl font-semibold mb-4">Lịch Sử Giao Dịch</h3>
                        <div className="max-h-96 overflow-y-auto">
                            <ul className="space-y-2">
                                {filteredFinancials.transactions.map(item => (
                                    <li key={item.id} className={`group p-3 rounded-lg flex justify-between items-center ${item.type === 'revenue' ? 'bg-green-50' : 'bg-red-50'}`}>
                                        <div>
                                            <p className="font-bold">{item.type === 'revenue' ? `Thu từ ${tenantsData.find(t => t.id === item.tenantId)?.name || 'N/A'}` : (item.category === 'Khác' ? item.description : item.category)}</p>
                                            <p className="text-sm text-gray-500">{formatDate(item.date)} - {item.type === 'expense' ? `Nhà: ${buildingsData.find(b => b.id === item.buildingId)?.name || 'N/A'}` : `Phòng: ${item.roomName}`}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className={`font-semibold ${item.type === 'revenue' ? 'text-green-600' : 'text-red-600'}`}>
                                                {item.type === 'revenue' ? '+' : '-'} {formatCurrency(item.amount)} VNĐ
                                            </p>
                                            {item.type === 'expense' && (
                                                <button onClick={() => onDeleteExpense(item.id)} className="text-xs text-gray-500 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity">Xóa</button>
                                            )}
                                        </div>
                                    </li>
                                ))}
                                {filteredFinancials.transactions.length === 0 && <p className="text-gray-500 text-center py-4">Chưa có giao dịch nào.</p>}
                            </ul>
                        </div>
                    </div>
                </div>
            );
        };

        const EditableListItem = ({ item, onUpdate, onDelete, isSelected, onClick, children }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [name, setName] = useState(item.name);

            const handleSave = () => {
                if (name.trim() !== '' && name.trim() !== item.name) {
                    onUpdate(item.id, name.trim());
                }
                setIsEditing(false);
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') handleSave();
                if (e.key === 'Escape') {
                    setName(item.name);
                    setIsEditing(false);
                }
            };

            return (
                <li onClick={onClick} className={`group p-2 rounded cursor-pointer transition-all flex justify-between items-center ${isSelected ? 'bg-blue-500 text-white shadow-lg' : 'bg-gray-100 hover:bg-blue-100'}`}>
                    <div className="flex items-center flex-grow">
                        {isEditing ? (
                            <input type="text" value={name} onChange={e => setName(e.target.value)} onBlur={handleSave} onKeyDown={handleKeyDown} autoFocus className="input-form text-black p-1 flex-grow"/>
                        ) : (
                            <span className="flex-grow">{item.name}</span>
                        )}
                        {item.isWholeUnit && (
                            <span title="Cho thuê nguyên căn" className="ml-2 text-gray-500">🏢</span>
                        )}
                    </div>
                    <div className="hidden group-hover:flex items-center gap-2 pl-2">
                        <button onClick={(e) => { e.stopPropagation(); setIsEditing(true); }} className="text-sm text-blue-600 hover:text-blue-800">Sửa</button>
                        <button onClick={(e) => { e.stopPropagation(); onDelete(item); }} className="text-sm text-red-600 hover:text-red-800">Xóa</button>
                    </div>
                    {children}
                </li>
            );
        };

        const Management = ({ 
            onAddBuilding, onAddRoom, onAddBed, onOpenAddTenantModal, onOpenContractModal,
            onUpdateItem, onDeleteItem, onUpdateTenant, onDeletePayment, onOpenEditTenantModal,
            newBuildingName, setNewBuildingName,
            newRoomName, setNewRoomName,
            newBedName, setNewBedName,
            buildingsData, tenantsData, paymentsData
        }) => {
            const [selectedBuilding, setSelectedBuilding] = useState(null);
            const [selectedRoom, setSelectedRoom] = useState(null);
            const [newRoomIsWholeUnit, setNewRoomIsWholeUnit] = useState(false);
            
            const useSubCollection = (parentCollection, parentId, subCollectionName) => {
                const [data, setData] = useState([]);
                useEffect(() => {
                    if (!parentId) { setData([]); return; }
                    const q = db.collection(parentCollection).doc(parentId).collection(subCollectionName);
                    const unsubscribe = q.onSnapshot((querySnapshot) => {
                        const items = [];
                        querySnapshot.forEach((doc) => {
                            items.push({ 
                                id: doc.id, 
                                ...doc.data(),
                                path: doc.ref.path
                            });
                        });
                        setData(items);
                    });
                    return () => unsubscribe();
                }, [parentId, subCollectionName]);
                return data;
            };

            const roomsData = useSubCollection('buildings', selectedBuilding?.id, 'rooms');
            const [bedsData, setBedsData] = useState([]);

            useEffect(() => {
                if (!selectedRoom?.id || !selectedBuilding?.id || selectedRoom.isWholeUnit) {
                    setBedsData([]);
                    return;
                }
                const path = `buildings/${selectedBuilding.id}/rooms/${selectedRoom.id}/beds`;
                const q = db.collection(path);
                const unsubscribe = q.onSnapshot((querySnapshot) => {
                    let items = [];
                    querySnapshot.forEach((doc) => {
                        items.push({ 
                            id: doc.id, 
                            ...doc.data(),
                            path: doc.ref.path,
                            roomId: selectedRoom.id,
                            buildingId: selectedBuilding.id,
                            roomName: selectedRoom.name,
                            buildingName: selectedBuilding.name
                        });
                    });
                    items.sort((a, b) => a.name.localeCompare(b.name));
                    setBedsData(items);
                });
                return () => unsubscribe();
            }, [selectedRoom, selectedBuilding]);

            const handleAddRoomInternal = (e) => {
                e.preventDefault();
                onAddRoom(e, selectedBuilding.id, newRoomIsWholeUnit);
                setNewRoomIsWholeUnit(false);
            };

            const handleAddBedInternal = (e) => { e.preventDefault(); if(!selectedRoom || !selectedBuilding) return; onAddBed(e, selectedRoom.id, selectedBuilding.id, selectedBuilding.name, selectedRoom.name); }

            return (
                <div className="p-4 md:p-8">
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 bg-white p-6 rounded-lg shadow">
                            <h2 className="text-xl font-semibold mb-4 border-b pb-2">Sơ Đồ Quản Lý</h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <h3 className="font-bold text-lg mb-2">1. Căn Nhà</h3>
                                    <form onSubmit={onAddBuilding} className="flex gap-2 mb-4"><input type="text" value={newBuildingName} onChange={e => setNewBuildingName(e.target.value)} placeholder="Tên nhà mới" className="input-form flex-grow"/><button type="submit" className="btn-primary">+</button></form>
                                    <ul className="space-y-2">{buildingsData.map(b => (<EditableListItem key={b.id} item={b} onUpdate={(id, name) => onUpdateItem('buildings', id, name)} onDelete={(item) => onDeleteItem('building', item)} isSelected={selectedBuilding?.id === b.id} onClick={() => { setSelectedBuilding(b); setSelectedRoom(null); }} />))}</ul>
                                </div>
                                <div>
                                    <h3 className="font-bold text-lg mb-2">2. Phòng</h3>
                                    {selectedBuilding && (<>
                                        <form onSubmit={handleAddRoomInternal} className="mb-4">
                                            <div className="flex gap-2">
                                                <input type="text" value={newRoomName} onChange={e => setNewRoomName(e.target.value)} placeholder="Tên phòng mới" className="input-form flex-grow"/>
                                                <button type="submit" className="btn-primary">+</button>
                                            </div>
                                            <div className="flex items-center mt-2">
                                                <input id="is-whole-unit" type="checkbox" checked={newRoomIsWholeUnit} onChange={e => setNewRoomIsWholeUnit(e.target.checked)} className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" />
                                                <label htmlFor="is-whole-unit" className="ml-2 block text-sm text-gray-900">Cho thuê nguyên căn?</label>
                                            </div>
                                        </form>
                                        <ul className="space-y-2">{roomsData.map(r => (
                                            <EditableListItem key={r.id} item={r} onUpdate={(id, name) => onUpdateItem(`buildings/${selectedBuilding.id}/rooms`, id, name)} onDelete={(item) => onDeleteItem('room', item, selectedBuilding.id)} isSelected={selectedRoom?.id === r.id} onClick={() => setSelectedRoom(r)}>
                                                {r.isWholeUnit && r.status !== 'occupied' && 
                                                    <button onClick={(e) => { 
                                                        e.stopPropagation(); 
                                                        onOpenContractModal({
                                                            ...r,
                                                            buildingId: selectedBuilding.id,
                                                            buildingName: selectedBuilding.name
                                                        }); 
                                                    }} className="btn-secondary text-xs ml-auto">Tạo HĐ</button>
                                                }
                                                {r.isWholeUnit && r.status === 'occupied' && <span className="text-xs font-semibold text-red-700 ml-auto">Đã thuê</span>}
                                            </EditableListItem>
                                        ))}</ul>
                                    </>)}
                                </div>
                                <div>
                                    <h3 className="font-bold text-lg mb-2">3. Giường</h3>
                                    {selectedRoom && !selectedRoom.isWholeUnit && (<>
                                        <form onSubmit={handleAddBedInternal} className="flex gap-2 mb-4"><input type="text" value={newBedName} onChange={e => setNewBedName(e.target.value)} placeholder="Tên giường mới" className="input-form flex-grow"/><button type="submit" className="btn-primary">+</button></form>
                                        <ul className="space-y-2">{bedsData.map(bed => (<EditableListItem key={bed.id} item={bed} onUpdate={(id, name) => onUpdateItem(bed.path, id, name)} onDelete={(item) => onDeleteItem('bed', item, { buildingId: selectedBuilding.id, roomId: selectedRoom.id })}>
                                            {bed.status === 'available' ? <button onClick={(e) => { e.stopPropagation(); onOpenContractModal(bed); }} className="btn-secondary text-xs ml-auto">Tạo HĐ</button> : <span className="text-xs font-semibold text-red-700 ml-auto">Đã thuê</span>}
                                        </EditableListItem>))}</ul>
                                    </>)}
                                    {selectedRoom && selectedRoom.isWholeUnit && (
                                        <div className="p-4 bg-gray-100 rounded-lg text-center text-gray-600">
                                            Phòng này được cho thuê nguyên căn.
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                        <div className="space-y-8">
                            <div className="bg-white p-6 rounded-lg shadow">
                                <div className="flex justify-between items-center mb-4 border-b pb-2"><h2 className="text-xl font-semibold">Người Thuê</h2><button onClick={onOpenAddTenantModal} className="btn-primary">Thêm Người Thuê</button></div>
                                <ul className="space-y-2 max-h-60 overflow-y-auto">{tenantsData.map(t => (<li key={t.id} className="group p-2 bg-gray-50 rounded flex justify-between items-center"><div className="flex-grow"><p className="font-bold">{t.name}</p><p className="text-sm text-gray-600">{t.phone} - {t.school}</p></div><div className="hidden group-hover:flex items-center gap-2 pl-2"><button onClick={() => onOpenEditTenantModal(t)} className="text-sm text-blue-600 hover:text-blue-800">Sửa</button><button onClick={() => onDeleteItem('tenant', t)} className="text-sm text-red-600 hover:text-red-800">Xóa</button></div></li>))}</ul>
                            </div>
                            <div className="bg-white p-6 rounded-lg shadow">
                                <h2 className="text-xl font-semibold mb-4 border-b pb-2">Các Khoản Đã Thanh Toán</h2>
                                <ul className="space-y-3 max-h-80 overflow-y-auto">{paymentsData.filter(p => p.status === 'paid').map(p => { const tenantInfo = tenantsData.find(t => t.id === p.tenantId); return (<li key={p.id} className="group p-3 bg-green-100 rounded-lg opacity-70 flex justify-between items-center"><div className="flex-grow"><p className="font-bold">{tenantInfo?.name || 'Không rõ'}</p><p className="text-md text-green-800 font-semibold">{formatCurrency(p.amount)} VNĐ</p></div><button onClick={() => onDeletePayment(p.id)} className="hidden group-hover:block text-sm text-red-600 hover:text-red-800 ml-2">Xóa</button></li>);})}{paymentsData.filter(p => p.status === 'paid').length === 0 && <p className="text-gray-500">Chưa có thanh toán nào.</p>}</ul>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ isOpen, view, setView, onClose }) => {
            const navItems = [
                { id: 'dashboard', label: 'Dashboard' },
                { id: 'finance', label: 'Tài Chính' },
                { id: 'directory', label: 'Danh Bạ Thuê' },
                { id: 'management', label: 'Quản Lý Chi Tiết' },
            ];

            return (
                <>
                    <div className={`fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity md:hidden ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={onClose}></div>
                    <div className={`fixed top-0 left-0 h-full bg-white w-64 z-50 transform transition-transform md:hidden ${isOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-4">
                             <h1 className="text-2xl font-bold text-blue-600">H4Rent</h1>
                        </div>
                        <nav className="mt-4">
                            {navItems.map(item => (
                                <button 
                                    key={item.id}
                                    onClick={() => { setView(item.id); onClose(); }} 
                                    className={`w-full text-left p-4 text-lg font-semibold ${view === item.id ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}`}
                                >
                                    {item.label}
                                </button>
                            ))}
                        </nav>
                    </div>
                </>
            );
        };

        const Header = ({ view, setView, onLogout, userEmail, onToggleSidebar, onOpenAddTenantModal }) => {
            const navItems = [
                { id: 'dashboard', label: 'Dashboard' },
                { id: 'finance', label: 'Tài Chính' },
                { id: 'directory', label: 'Danh Bạ Thuê' },
                { id: 'management', label: 'Quản Lý Chi Tiết' },
            ];

            return (
                <header className="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-30">
                    <div className="flex items-center gap-2 md:gap-8">
                        <button onClick={onToggleSidebar} className="p-2 md:hidden">
                             <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <h1 className="text-2xl font-bold text-blue-600">H4Rent</h1>
                        <nav className="hidden md:flex gap-4">
                            {navItems.map(item => (
                                <button key={item.id} onClick={() => setView(item.id)} className={`pb-1 font-semibold ${view === item.id ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>{item.label}</button>
                            ))}
                        </nav>
                    </div>
                    <div className="flex items-center gap-2">
                        <button onClick={onOpenAddTenantModal} className="p-2 md:hidden text-gray-600 hover:text-blue-600">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                        </button>
                        <span className="text-gray-700 mr-2 hidden sm:inline">Chào, {userEmail}</span>
                        <button onClick={onLogout} className="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Đăng Xuất</button>
                    </div>
                </header>
            );
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('dashboard');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [confirmModal, setConfirmModal] = useState({ show: false, title: '', message: '', onConfirm: () => {} });

            const [newBuildingName, setNewBuildingName] = useState('');
            const [newRoomName, setNewRoomName] = useState('');
            const [newBedName, setNewBedName] = useState('');

            // State for Modals (lifted up)
            const [showContractModal, setShowContractModal] = useState(false);
            const [showAddTenantModal, setShowAddTenantModal] = useState(false);
            const [showEditTenantModal, setShowEditTenantModal] = useState(false);

            // State for Modal Data
            const [contractData, setContractData] = useState({ bedId: null, tenantId: '', paymentCycle: '3', rentPrice: '2000000' });
            const [newTenant, setNewTenant] = useState({ name: '', phone: '', idCard: '', school: '' });
            const [editingTenant, setEditingTenant] = useState(null);

            // State for Gemini feature
            const [generatedContractText, setGeneratedContractText] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);
            const [copySuccess, setCopySuccess] = useState('');

            const useCollection = (collectionName) => {
                const [data, setData] = useState([]);
                useEffect(() => {
                    if (!user) { setData([]); return; }
                    const q = db.collection(collectionName);
                    const unsubscribe = q.onSnapshot((querySnapshot) => {
                        const items = [];
                        querySnapshot.forEach((doc) => items.push({ id: doc.id, ...doc.data() }));
                        setData(items);
                    });
                    return () => unsubscribe();
                }, [user, collectionName]);
                return data;
            };

            const useCollectionGroup = (collectionId) => {
                const [data, setData] = useState([]);
                useEffect(() => {
                    if (!user) { setData([]); return; }
                    const q = db.collectionGroup(collectionId);
                    const unsubscribe = q.onSnapshot((querySnapshot) => {
                        const items = [];
                        querySnapshot.forEach((doc) => {
                            const bedData = doc.data();
                            bedData.path = doc.ref.path;
                            items.push({ id: doc.id, ...bedData });
                        });
                        setData(items);
                    });
                    return () => unsubscribe();
                }, [user, collectionId]);
                return data;
            };
            
            const buildingsData = useCollection('buildings');
            const tenantsData = useCollection('tenants');
            const paymentsData = useCollection('payments');
            const contractsData = useCollection('contracts');
            const allBedsData = useCollectionGroup('beds');
            const expensesData = useCollection('expenses');

            const availableTenants = useMemo(() => {
                const occupiedTenantIds = new Set(
                    allBedsData
                        .filter(bed => bed.status === 'occupied' && bed.tenantId)
                        .map(bed => bed.tenantId)
                );
                return tenantsData.filter(tenant => !occupiedTenantIds.has(tenant.id));
            }, [tenantsData, allBedsData]);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleUpdateItem = async (path, id, newName) => {
                const itemRef = db.doc(`${path}/${id}`);
                await itemRef.update({ name: newName });
            };
            
            const handleUpdateTenant = async (tenantId, updatedData) => {
                const tenantRef = db.collection('tenants').doc(tenantId);
                await tenantRef.update(updatedData);
                setShowEditTenantModal(false);
                setEditingTenant(null);
            };

            const handleDeletePayment = (paymentId) => {
                const onConfirm = async () => {
                    await db.collection('payments').doc(paymentId).delete();
                    setConfirmModal({ show: false });
                };
                setConfirmModal({ show: true, title: 'Xác nhận xóa thanh toán', message: 'Bạn có chắc chắn muốn xóa khoản thanh toán này?', onConfirm });
            };

            const handleDeleteItem = (type, item, parentData = null) => {
                const onConfirm = async () => {
                    try {
                        if (type === 'bed') {
                            if (item.status === 'occupied') { alert('Không thể xóa giường đã có người thuê.'); return; }
                            if (!parentData?.buildingId || !parentData?.roomId) {
                                alert('Không thể xóa giường, thiếu thông tin phòng/nhà.');
                                return;
                            }
                            await db.doc(`buildings/${parentData.buildingId}/rooms/${parentData.roomId}/beds/${item.id}`).delete();
                        } else if (type === 'room') {
                            const buildingId = parentData;
                            const batch = db.batch();
                            const roomRef = db.doc(`buildings/${buildingId}/rooms/${item.id}`);
                            const bedsQuery = db.collection(`buildings/${buildingId}/rooms/${item.id}/beds`);
                            const bedsSnapshot = await bedsQuery.get();
                            bedsSnapshot.forEach(bedDoc => batch.delete(bedDoc.ref));
                            batch.delete(roomRef);
                            await batch.commit();
                        } else if (type === 'building') {
                            const batch = db.batch();
                            const buildingRef = db.collection('buildings').doc(item.id);
                            const roomsQuery = db.collection(`buildings/${item.id}/rooms`);
                            const roomsSnapshot = await roomsQuery.get();
                            for (const roomDoc of roomsSnapshot.docs) {
                                const bedsQuery = db.collection(`buildings/${roomDoc.id}/rooms/${roomDoc.id}/beds`);
                                const bedsSnapshot = await bedsQuery.get();
                                bedsSnapshot.forEach(bedDoc => batch.delete(bedDoc.ref));
                                batch.delete(roomDoc.ref);
                            }
                            batch.delete(buildingRef);
                            await batch.commit();
                        } else if (type === 'tenant') {
                            const bedsQuery = db.collectionGroup('beds').where('tenantId', '==', item.id);
                            const bedsSnapshot = await bedsQuery.get();
                            if (!bedsSnapshot.empty) {
                                alert('Không thể xóa người thuê đang có hợp đồng. Vui lòng kết thúc hợp đồng trước.');
                                return;
                            }
                            await db.collection('tenants').doc(item.id).delete();
                        }
                    } catch (error) {
                        console.error("Lỗi khi xóa:", error);
                        alert("Đã có lỗi xảy ra khi xóa.");
                    } finally {
                        setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} });
                    }
                };
                setConfirmModal({ show: true, title: `Xác nhận xóa`, message: `Bạn có chắc chắn muốn xóa "${item.name}"? Hành động này không thể hoàn tác.`, onConfirm });
            };

            const handleAddBuilding = async (e) => { e.preventDefault(); if (newBuildingName.trim() === '') return; await db.collection('buildings').add({ name: newBuildingName, createdAt: Timestamp.now() }); setNewBuildingName(''); };
            
            const handleAddRoom = async (e, buildingId, isWholeUnit) => { 
                e.preventDefault(); 
                if (newRoomName.trim() === '' || !buildingId) return; 
                await db.collection('buildings').doc(buildingId).collection('rooms').add({ 
                    name: newRoomName, 
                    isWholeUnit: isWholeUnit,
                    status: 'available',
                    createdAt: Timestamp.now() 
                }); 
                setNewRoomName(''); 
            };
            
            const handleAddBed = async (e, roomId, buildingId, buildingName, roomName) => { e.preventDefault(); if (newBedName.trim() === '' || !roomId || !buildingId) return; await db.collection('buildings').doc(buildingId).collection('rooms').doc(roomId).collection('beds').add({ name: newBedName, status: 'available', tenantId: null, createdAt: Timestamp.now(), buildingId, roomId, buildingName, roomName }); setNewBedName(''); };
            
            const handleAddTenant = async (tenantData) => { 
                if (tenantData.name.trim() === '' || tenantData.phone.trim() === '') return; 
                await db.collection('tenants').add(tenantData); 
                setNewTenant({ name: '', phone: '', idCard: '', school: '' });
                setShowAddTenantModal(false);
            };
            
            const handleAddExpense = async (expenseData) => {
                await db.collection('expenses').add({ ...expenseData, createdAt: Timestamp.now() });
            };
            
            const handleDeleteExpense = (expenseId) => {
                const onConfirm = async () => {
                    await db.collection('expenses').doc(expenseId).delete();
                    setConfirmModal({ show: false });
                };
                setConfirmModal({ show: true, title: 'Xác nhận xóa chi phí', message: 'Bạn có chắc chắn muốn xóa khoản chi phí này?', onConfirm });
            };

            const handleCreateContract = async (contractDataPayload) => { 
                if(!contractDataPayload.tenantId || !contractDataPayload.itemId) { 
                    alert("Vui lòng chọn người thuê!"); 
                    return; 
                } 
                if(!contractDataPayload.itemPath) {
                    alert("Lỗi: Không tìm thấy đường dẫn của phòng/giường. Không thể cập nhật trạng thái.");
                    return;
                }
                try { 
                    const contractRef = await db.collection('contracts').add({ ...contractDataPayload, startDate: Timestamp.now() }); 
                    const amount = parseInt(contractDataPayload.rentPrice) * parseInt(contractDataPayload.paymentCycle); 
                    await db.collection('payments').add({ 
                        contractId: contractRef.id, 
                        tenantId: contractDataPayload.tenantId, 
                        amount: amount, 
                        dueDate: Timestamp.now(), 
                        status: 'unpaid',
                        buildingId: contractDataPayload.buildingId,
                        buildingName: contractDataPayload.buildingName,
                        roomName: contractDataPayload.roomName
                    }); 
                    
                    const itemRef = db.doc(contractDataPayload.itemPath); 
                    await itemRef.update({ status: 'occupied', tenantId: contractDataPayload.tenantId }); 
                    
                    setShowContractModal(false);
                    setContractData({ bedId: null, tenantId: '', paymentCycle: '3', rentPrice: '2000000' });
                } catch (error) { 
                    console.error("Lỗi tạo hợp đồng:", error); 
                    alert("Đã có lỗi xảy ra khi tạo hợp đồng."); 
                }
            };
            
            const handleUpdatePaymentStatus = async (paymentId, newStatus) => { const paymentRef = db.collection('payments').doc(paymentId); await paymentRef.update({ status: newStatus }); };
            const handleLogout = () => { auth.signOut(); };

            const handleOpenContractModal = (item) => {
                const isRoom = !!item.isWholeUnit;
                const itemForContract = { ...item };

                if (!itemForContract.buildingId && itemForContract.buildingName) {
                    const building = buildingsData.find(b => b.name === itemForContract.buildingName);
                    if (building) {
                        itemForContract.buildingId = building.id;
                    }
                }
                
                if (!itemForContract.id || !itemForContract.path) {
                    alert('Thông tin phòng/giường không đầy đủ để tạo hợp đồng. Thiếu ID hoặc đường dẫn.');
                    console.error('Invalid item data for contract:', itemForContract);
                    return;
                }

                setContractData({
                    itemId: itemForContract.id,
                    itemType: isRoom ? 'room' : 'bed',
                    roomId: isRoom ? itemForContract.id : itemForContract.roomId,
                    buildingId: itemForContract.buildingId,
                    buildingName: itemForContract.buildingName,
                    roomName: isRoom ? itemForContract.name : itemForContract.roomName,
                    tenantId: '',
                    paymentCycle: '3',
                    rentPrice: isRoom ? '15000000' : '2000000',
                    itemPath: itemForContract.path
                });
                setShowContractModal(true);
            };

            const handleOpenAddTenantModal = () => {
                setNewTenant({ name: '', phone: '', idCard: '', school: '' });
                setShowAddTenantModal(true);
            };

            const handleOpenEditTenantModal = (tenant) => {
                setEditingTenant(tenant);
                setShowEditTenantModal(true);
            };

            const handleGenerateContractText = async () => {
                if (!contractData.tenantId || !contractData.itemId) {
                    alert("Vui lòng chọn người thuê và phòng/giường trước khi soạn thảo.");
                    return;
                }
                setIsGenerating(true);
                setGeneratedContractText('');
                setCopySuccess('');

                const tenant = tenantsData.find(t => t.id === contractData.tenantId);
                const itemName = contractData.itemType === 'room' ? contractData.roomName : allBedsData.find(b => b.id === contractData.itemId)?.name;
                
                const prompt = `
                    Hãy soạn thảo các điều khoản hợp đồng cho thuê nhà đơn giản bằng tiếng Việt cho các thông tin sau:
                    - Tên người thuê: ${tenant?.name}
                    - Số điện thoại: ${tenant?.phone}
                    - Đối tượng thuê: ${contractData.itemType === 'room' ? `Phòng ${itemName}` : `Giường ${itemName}`}
                    - Thuộc phòng: ${contractData.roomName}
                    - Tại nhà: ${contractData.buildingName}
                    - Giá thuê hàng tháng: ${formatCurrency(contractData.rentPrice)} VNĐ
                    - Kỳ thanh toán: ${contractData.paymentCycle} tháng một lần
                    - Tổng tiền thanh toán mỗi kỳ: ${formatCurrency(parseInt(contractData.rentPrice) * parseInt(contractData.paymentCycle))} VNĐ

                    Nội dung cần bao gồm các mục chính sau:
                    1. Thông tin các bên.
                    2. Đối tượng hợp đồng.
                    3. Giá thuê và phương thức thanh toán.
                    4. Thời hạn hợp đồng.
                    5. Quyền và nghĩa vụ của các bên.
                    6. Điều khoản chung và chữ ký.

                    Vui lòng trình bày rõ ràng, chuyên nghiệp và dễ hiểu.
                `;

                try {
                    const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = ""; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                    const result = await response.json();

                    if (result.candidates?.[0]?.content?.parts?.[0]) {
                        setGeneratedContractText(result.candidates[0].content.parts[0].text);
                    } else {
                        console.error("Unexpected API response structure:", result);
                        setGeneratedContractText("Không thể tạo nội dung hợp đồng. Phản hồi từ API không hợp lệ.");
                    }
                } catch (error) {
                    console.error("Lỗi khi gọi Gemini API:", error);
                    setGeneratedContractText("Đã có lỗi xảy ra khi tạo nội dung hợp đồng. Vui lòng thử lại.");
                } finally {
                    setIsGenerating(false);
                }
            };

            const copyToClipboard = (text) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    setCopySuccess('Đã sao chép!');
                    setTimeout(() => setCopySuccess(''), 2000);
                } catch (err) {
                    setCopySuccess('Sao chép thất bại!');
                    console.error('Không thể sao chép: ', err);
                }
                document.body.removeChild(textArea);
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center">Đang tải...</div>;
            if (!user) return <LoginScreen />;

            return (
                <div className="bg-gray-50 min-h-screen">
                    <Sidebar 
                        isOpen={isSidebarOpen}
                        onClose={() => setIsSidebarOpen(false)}
                        view={view}
                        setView={setView}
                    />
                    <Header
                        view={view}
                        setView={setView}
                        onLogout={handleLogout}
                        userEmail={user.email}
                        onToggleSidebar={() => setIsSidebarOpen(!isSidebarOpen)}
                        onOpenAddTenantModal={handleOpenAddTenantModal}
                    />
                    <main>
                        {view === 'dashboard' && <Dashboard allBeds={allBedsData} tenants={tenantsData} contracts={contractsData} payments={paymentsData} buildingsData={buildingsData} onUpdatePaymentStatus={handleUpdatePaymentStatus} onOpenContractModal={handleOpenContractModal} />}
                        {view === 'finance' && <FinanceManagement tenantsData={tenantsData} buildingsData={buildingsData} expensesData={expensesData} paymentsData={paymentsData} onAddExpense={handleAddExpense} onDeleteExpense={handleDeleteExpense} />}
                        {view === 'directory' && <TenantDirectory allBeds={allBedsData} tenantsData={tenantsData} buildingsData={buildingsData} />}
                        {view === 'management' && <Management onAddBuilding={handleAddBuilding} onAddRoom={handleAddRoom} onAddBed={handleAddBed} onOpenAddTenantModal={handleOpenAddTenantModal} onOpenContractModal={handleOpenContractModal} onUpdateItem={handleUpdateItem} onDeleteItem={handleDeleteItem} onUpdateTenant={handleUpdateTenant} onDeletePayment={handleDeletePayment} onOpenEditTenantModal={handleOpenEditTenantModal} newBuildingName={newBuildingName} setNewBuildingName={setNewBuildingName} newRoomName={newRoomName} setNewRoomName={setNewRoomName} newBedName={newBedName} setNewBedName={setNewBedName} buildingsData={buildingsData} tenantsData={tenantsData} paymentsData={paymentsData}/>}
                    </main>
                    <ConfirmationModal show={confirmModal.show} onClose={() => setConfirmModal({ show: false })} onConfirm={confirmModal.onConfirm} title={confirmModal.title} message={confirmModal.message} />
                    
                    <Modal show={showAddTenantModal} onClose={() => setShowAddTenantModal(false)} title="Thêm Người Thuê Mới">
                        <form onSubmit={(e) => { e.preventDefault(); handleAddTenant(newTenant); }}>
                            <div className="space-y-4">
                                <input value={newTenant.name} onChange={e => setNewTenant({...newTenant, name: e.target.value})} placeholder="Họ và Tên" className="input-form w-full" required/>
                                <input value={newTenant.phone} onChange={e => setNewTenant({...newTenant, phone: e.target.value})} placeholder="Số điện thoại" className="input-form w-full" required/>
                                <input value={newTenant.idCard} onChange={e => setNewTenant({...newTenant, idCard: e.target.value})} placeholder="Số CCCD" className="input-form w-full"/>
                                <input value={newTenant.school} onChange={e => setNewTenant({...newTenant, school: e.target.value})} placeholder="Trường học/Nơi làm việc" className="input-form w-full"/>
                                <button type="submit" className="btn-primary w-full">Lưu</button>
                            </div>
                        </form>
                    </Modal>

                    {editingTenant && (
                        <Modal show={showEditTenantModal} onClose={() => setShowEditTenantModal(false)} title="Sửa Thông Tin Người Thuê">
                            <form onSubmit={(e) => { e.preventDefault(); handleUpdateTenant(editingTenant.id, editingTenant); }}>
                                <div className="space-y-4">
                                    <input value={editingTenant.name} onChange={e => setEditingTenant({...editingTenant, name: e.target.value})} placeholder="Họ và Tên" className="input-form w-full" required/>
                                    <input value={editingTenant.phone} onChange={e => setEditingTenant({...editingTenant, phone: e.target.value})} placeholder="Số điện thoại" className="input-form w-full" required/>
                                    <input value={editingTenant.idCard} onChange={e => setEditingTenant({...editingTenant, idCard: e.target.value})} placeholder="Số CCCD" className="input-form w-full"/>
                                    <input value={editingTenant.school} onChange={e => setEditingTenant({...editingTenant, school: e.target.value})} placeholder="Trường học/Nơi làm việc" className="input-form w-full"/>
                                    <button type="submit" className="btn-primary w-full">Cập Nhật</button>
                                </div>
                            </form>
                        </Modal>
                    )}

                    <Modal show={showContractModal} onClose={() => {setShowContractModal(false); setGeneratedContractText(''); setCopySuccess('');}} title="Tạo Hợp Đồng Mới">
                        <form onSubmit={(e) => {e.preventDefault(); handleCreateContract(contractData);}}>
                            <div className="space-y-4">
                                <div><label className="block text-sm font-medium text-gray-700">Chọn người thuê</label><select value={contractData.tenantId} onChange={e => setContractData({...contractData, tenantId: e.target.value})} className="input-form w-full" required><option value="">-- Chọn --</option>{availableTenants.length > 0 ? availableTenants.map(t => <option key={t.id} value={t.id}>{t.name} - {t.phone}</option>) : <option disabled>Không có người thuê nào trống</option>}</select></div>
                                <div><label className="block text-sm font-medium text-gray-700">Giá thuê 1 tháng (VNĐ)</label><input type="number" value={contractData.rentPrice} onChange={e => setContractData({...contractData, rentPrice: e.target.value})} className="input-form w-full"/></div>
                                <div><label className="block text-sm font-medium text-gray-700">Kỳ thanh toán</label><select value={contractData.paymentCycle} onChange={e => setContractData({...contractData, paymentCycle: e.target.value})} className="input-form w-full"><option value="3">3 Tháng</option><option value="6">6 Tháng</option></select></div>
                                <div className="p-4 bg-blue-50 rounded-lg text-center"><p className="text-gray-600">Tổng tiền cho kỳ đầu tiên:</p><p className="text-2xl font-bold text-blue-700">{formatCurrency(parseInt(contractData.rentPrice) * parseInt(contractData.paymentCycle))} VNĐ</p></div>
                                
                                <hr/>

                                <button type="button" onClick={handleGenerateContractText} disabled={isGenerating} className="w-full flex justify-center items-center gap-2 btn-secondary bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    {isGenerating ? 'Đang soạn thảo...' : 'Soạn Thảo Khoản Hợp Đồng ✨'}
                                </button>

                                {isGenerating && <div className="text-center p-4 text-purple-700">Đang kết nối với AI, vui lòng chờ...</div>}

                                {generatedContractText && (
                                    <div className="mt-4 p-4 border rounded-lg bg-gray-50">
                                        <h4 className="font-semibold text-lg mb-2">Nội dung hợp đồng gợi ý:</h4>
                                        <textarea readOnly className="w-full h-64 p-2 border rounded bg-white font-mono text-sm" value={generatedContractText}></textarea>
                                        <div className="mt-2">
                                            <button type="button" onClick={() => copyToClipboard(generatedContractText)} className="btn-secondary bg-gray-600 hover:bg-gray-700">
                                                Sao chép nội dung
                                            </button>
                                            {copySuccess && <span className="ml-4 text-green-600 font-semibold">{copySuccess}</span>}
                                        </div>
                                    </div>
                                )}

                                <hr/>

                                <button type="submit" className="btn-primary w-full">Xác Nhận Tạo Hợp Đồng</button>
                            </div>
                        </form>
                    </Modal>
                </div>
            );
        };

        // --- RENDER THE APP TO THE DOM USING REACT 18 API ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
