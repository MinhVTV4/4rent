<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H4Rent Management</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM for UI -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDKs (Compat version for easier browser usage) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles from the original app */
        .input-form { 
            display: block; 
            width: 100%; 
            padding: 0.5rem 0.75rem; 
            font-size: 1rem; 
            line-height: 1.5; 
            color: #495057; 
            background-color: #fff; 
            background-clip: padding-box; 
            border: 1px solid #ced4da; 
            border-radius: 0.375rem; 
            transition: border-color .15s ease-in-out,box-shadow .15s ease-in-out; 
        }
        .input-form:focus { 
            color: #495057; 
            background-color: #fff; 
            border-color: #80bdff; 
            outline: 0; 
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); 
        }
        .btn-primary { 
            color: #fff; 
            background-color: #007bff; 
            border-color: #007bff; 
            padding: 0.5rem 1rem; 
            font-size: 1rem; 
            border-radius: 0.375rem; 
            cursor: pointer; 
            font-weight: bold; 
            transition: background-color 0.2s; 
        }
        .btn-primary:hover { 
            background-color: #0056b3; 
        }
        .btn-secondary { 
            color: #fff; 
            background-color: #6c757d; 
            border-color: #6c757d; 
            padding: 0.25rem 0.5rem; 
            font-size: 0.875rem; 
            border-radius: 0.25rem; 
            cursor: pointer; 
            font-weight: bold; 
            transition: background-color 0.2s; 
        }
        .btn-secondary:hover { 
            background-color: #5a6268; 
        }
    </style>
</head>
<body>
    <!-- The root element where the React app will be mounted -->
    <div id="root"></div>

    <!-- The React application code, transpiled by Babel -->
    <script type="text/babel">
        // --- DESTRUCTURE REACT HOOKS FROM GLOBAL React OBJECT ---
        const { useState, useEffect, useMemo, useRef } = React;

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCOofbN91yeOEWeAIP6wHgtGBfLZi9qJ1Y",
            authDomain: "h4rent-c12ef.firebaseapp.com",
            projectId: "h4rent-c12ef",
            storageBucket: "h4rent-c12ef.appspot.com",
            messagingSenderId: "860501720608",
            appId: "1:860501720608:web:d6a81ae6aeba099c72c645"
        };

        // --- INITIALIZE FIREBASE USING COMPAT LIBRARIES ---
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const { Timestamp } = firebase.firestore;

        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (amount) => new Intl.NumberFormat('vi-VN').format(amount);
        const formatDate = (date) => {
            if (!date) return 'N/A';
            const jsDate = date.toDate ? date.toDate() : new Date(date);
            return jsDate.toLocaleDateString('vi-VN');
        };

        // --- CHART COMPONENTS ---
        const FinanceColumnChart = ({ chartData }) => {
            const chartRef = useRef(null);
            const chartInstanceRef = useRef(null);

            useEffect(() => {
                if (chartInstanceRef.current) {
                    chartInstanceRef.current.destroy();
                }
                if (!chartRef.current || !chartData) return;

                const myChartRef = chartRef.current.getContext("2d");
                
                chartInstanceRef.current = new Chart(myChartRef, {
                    type: "bar",
                    data: {
                        labels: chartData.labels,
                        datasets: [
                            {
                                label: "Doanh thu",
                                data: chartData.revenueData,
                                backgroundColor: "rgba(54, 162, 235, 0.6)",
                                borderColor: "rgba(54, 162, 235, 1)",
                                borderWidth: 1,
                            },
                            {
                                label: "Chi ph√≠",
                                data: chartData.expenseData,
                                backgroundColor: "rgba(255, 99, 132, 0.6)",
                                borderColor: "rgba(255, 99, 132, 1)",
                                borderWidth: 1,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.destroy();
                    }
                }
            }, [chartData]);

            return <div style={{height: '300px'}}><canvas ref={chartRef} /></div>;
        };

        const ExpensePieChart = ({ chartData }) => {
            const chartRef = useRef(null);
            const chartInstanceRef = useRef(null);

            useEffect(() => {
                if (chartInstanceRef.current) {
                    chartInstanceRef.current.destroy();
                }
                 if (!chartRef.current || !chartData || chartData.data.length === 0) return;

                const myChartRef = chartRef.current.getContext("2d");
                
                chartInstanceRef.current = new Chart(myChartRef, {
                    type: "pie",
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            data: chartData.data,
                             backgroundColor: [
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 206, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)',
                                'rgba(255, 159, 64, 0.8)'
                            ],
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += formatCurrency(context.parsed) + ' VNƒê';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });

                return () => {
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.destroy();
                    }
                }
            }, [chartData]);

            return <div style={{height: '300px'}}><canvas ref={chartRef} /></div>;
        };


        // --- MAIN UI COMPONENTS ---

        const LoginScreen = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (err) {
                    setError('Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng. Vui l√≤ng th·ª≠ l·∫°i.');
                    console.error("L·ªói ƒëƒÉng nh·∫≠p:", err);
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-lg shadow-md w-full max-w-md">
                        <h1 className="text-2xl font-bold text-center text-gray-800 mb-6">ƒêƒÉng Nh·∫≠p Qu·∫£n Tr·ªã</h1>
                        <form onSubmit={handleLogin}>
                            <div className="mb-4">
                                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="email">Email</label>
                                <input id="email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="input-form" placeholder="admin@example.com" required />
                            </div>
                            <div className="mb-6">
                                <label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">M·∫≠t kh·∫©u</label>
                                <input id="password" type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="input-form" placeholder="******************" required />
                            </div>
                            {error && (
                                <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                                    <span className="block sm:inline">{error}</span>
                                </div>
                            )}
                            <button type="submit" className="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">ƒêƒÉng Nh·∫≠p</button>
                        </form>
                    </div>
                </div>
            );
        };

        const Modal = ({ show, onClose, title, children }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-lg">
                        <div className="p-4 border-b flex justify-between items-center">
                            <h3 className="text-xl font-semibold">{title}</h3>
                            <button onClick={onClose} className="text-black text-2xl font-bold">&times;</button>
                        </div>
                        <div className="p-4 max-h-[80vh] overflow-y-auto">{children}</div>
                    </div>
                </div>
            );
        };

        const ConfirmationModal = ({ show, onClose, onConfirm, title, message }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-sm">
                        <div className="p-6">
                            <h3 className="text-xl font-bold text-gray-900">{title}</h3>
                            <p className="mt-2 text-sm text-gray-600">{message}</p>
                        </div>
                        <div className="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                            <button type="button" onClick={onConfirm} className="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">X√≥a</button>
                            <button type="button" onClick={onClose} className="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:w-auto sm:text-sm">H·ªßy</button>
                        </div>
                    </div>
                </div>
            );
        };

        const BottomSheet = ({ show, onClose, title, data, type, onOpenContractModal }) => {
            const [openBuildingName, setOpenBuildingName] = useState(null);

            const toggleBuilding = (buildingName) => {
                setOpenBuildingName(prev => (prev === buildingName ? null : buildingName));
            };

            const isBedList = ['available', 'occupied', 'total'].includes(type);

            const groupedData = useMemo(() => {
                if (!isBedList) return [];
                const groups = data.reduce((acc, item) => {
                    const key = item.buildingName || 'Ch∆∞a x√°c ƒë·ªãnh';
                    if (!acc[key]) {
                        acc[key] = [];
                    }
                    acc[key].push(item);
                    return acc;
                }, {});
                return Object.entries(groups).map(([buildingName, items]) => ({
                    buildingName,
                    items
                }));
            }, [data, isBedList]);

            return (
                <div className={`fixed inset-0 bg-black bg-opacity-50 z-50 transition-opacity duration-300 ${show ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={onClose}>
                    <div className={`fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-2xl transform transition-transform duration-300 ease-out ${show ? 'translate-y-0' : 'translate-y-full'}`} onClick={(e) => e.stopPropagation()}>
                        <div className="p-4 border-b">
                            <div className="flex justify-between items-center"><h3 className="text-xl font-semibold">{title}</h3><button onClick={onClose} className="text-gray-500 text-2xl font-bold">&times;</button></div>
                        </div>
                        <div className="p-4 max-h-[60vh] overflow-y-auto">
                            {isBedList ? (
                                <div className="space-y-2">
                                    {groupedData.map(group => (
                                        <div key={group.buildingName} className="border rounded-lg overflow-hidden">
                                            <button onClick={() => toggleBuilding(group.buildingName)} className="w-full text-left p-3 bg-gray-50 hover:bg-gray-100 focus:outline-none flex justify-between items-center transition">
                                                <h4 className="font-bold text-lg text-gray-800">{group.buildingName} ({group.items.length})</h4>
                                                <span className={`transform transition-transform duration-300 ${openBuildingName === group.buildingName ? 'rotate-180' : ''}`}>
                                                    <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                                                </span>
                                            </button>
                                            {openBuildingName === group.buildingName && (
                                                <ul className="space-y-2 mt-2 p-3 border-t">
                                                    {group.items.map(item => (
                                                        <li key={item.id} className="p-3 bg-gray-50 rounded-lg flex justify-between items-center">
                                                            <div>
                                                                <p className="font-bold">{item.name}</p>
                                                                <p className="text-sm text-gray-600">{item.roomName || 'Ph√≤ng kh√¥ng x√°c ƒë·ªãnh'}</p>
                                                            </div>
                                                            {type === 'available' && (
                                                                <button onClick={() => onOpenContractModal(item)} className="btn-secondary text-xs">T·∫°o Hƒê</button>
                                                            )}
                                                        </li>
                                                    ))}
                                                </ul>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <ul className="space-y-3">
                                    {data.map(c => { 
                                        const tenantInfo = tenants.find(t => t.id === c.tenantId); 
                                        return (<li key={c.id} className="p-3 bg-gray-100 rounded-lg"><p className="font-bold">{tenantInfo?.name || 'Kh√¥ng r√µ'}</p><p className="text-sm text-gray-600">H·∫øt h·∫°n: {formatDate(c.endDate)}</p></li>)
                                    })}
                                </ul>
                            )}
                            {data.length === 0 && <p className="text-gray-500 text-center py-4">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>}
                        </div>
                    </div>
                </div>
            );
        };

        const StatCard = ({ title, value, subtext, colorClass, onClick, children }) => (
            <div 
                className={`p-6 rounded-lg shadow-lg text-white ${colorClass} transition-all duration-300 ease-in-out ${onClick ? 'cursor-pointer hover:scale-105 hover:shadow-xl' : ''}`} 
                onClick={onClick}
            >
                {children ? children : (
                    <>
                        <p className="text-lg font-semibold">{title}</p>
                        <p className="text-4xl font-bold">{value}</p>
                        <p className="text-sm opacity-80">{subtext}</p>
                    </>
                )}
            </div>
        );

        const Dashboard = ({ allBeds, tenants, contracts, payments, buildingsData, onUpdatePaymentStatus, onOpenContractModal }) => {
            const [bottomSheet, setBottomSheet] = useState({ show: false, title: '', data: [], type: '' });

            const stats = useMemo(() => {
                const totalBuildings = buildingsData.length;
                const totalBeds = allBeds.length;
                const occupiedBeds = allBeds.filter(b => b.status === 'occupied').length;
                const availableBeds = totalBeds - occupiedBeds;
                return { totalBuildings, totalBeds, occupiedBeds, availableBeds };
            }, [allBeds, buildingsData]);

            const expiringContracts = useMemo(() => {
                const now = new Date();
                const thirtyDaysFromNow = new Date();
                thirtyDaysFromNow.setDate(now.getDate() + 30);
                return contracts.map(c => { 
                    const startDate = c.startDate.toDate(); 
                    const endDate = new Date(startDate); 
                    endDate.setMonth(startDate.getMonth() + parseInt(c.paymentCycle)); 
                    return { ...c, endDate }; 
                }).filter(c => c.endDate > now && c.endDate <= thirtyDaysFromNow);
            }, [contracts]);

            const handleStatCardClick = (type) => {
                let title = ''; let data = [];
                switch (type) {
                    case 'occupied': title = 'Gi∆∞·ªùng ƒë√£ thu√™'; data = allBeds.filter(b => b.status === 'occupied'); break;
                    case 'available': title = 'Gi∆∞·ªùng c√≤n tr·ªëng'; data = allBeds.filter(b => b.status === 'available'); break;
                    case 'expiring': title = 'H·ª£p ƒë·ªìng s·∫Øp h·∫øt h·∫°n'; data = expiringContracts; break;
                    default: return;
                }
                setBottomSheet({ show: true, title, data, type });
            };

            return (
                <>
                    <div className="p-4 md:p-8 space-y-8">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <StatCard title="T·ªïng Quan H·ªá Th·ªëng" colorClass="bg-purple-500">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <p className="text-lg font-semibold">S·ªë nh√†</p>
                                        <p className="text-4xl font-bold">{stats.totalBuildings}</p>
                                    </div>
                                    <div className="border-l-2 border-purple-400 h-16 mx-4"></div>
                                    <div>
                                        <p className="text-lg font-semibold">S·ªë gi∆∞·ªùng</p>
                                        <p className="text-4xl font-bold">{stats.totalBeds}</p>
                                    </div>
                                </div>
                            </StatCard>
                            <StatCard title="Gi∆∞·ªùng c√≤n tr·ªëng" value={stats.availableBeds} subtext="S·∫µn s√†ng cho thu√™" colorClass="bg-yellow-500" onClick={() => handleStatCardClick('available')} />
                            <StatCard title="Gi∆∞·ªùng ƒë√£ thu√™" value={stats.occupiedBeds} subtext={`${stats.totalBeds > 0 ? ((stats.occupiedBeds / stats.totalBeds) * 100).toFixed(1) : 0}% l·∫•p ƒë·∫ßy`} colorClass="bg-green-500" onClick={() => handleStatCardClick('occupied')} />
                            <StatCard title="H·ª£p ƒë·ªìng s·∫Øp h·∫øt h·∫°n" value={expiringContracts.length} subtext="Trong 30 ng√†y t·ªõi" colorClass="bg-red-500" onClick={() => handleStatCardClick('expiring')} />
                        </div>
                        <div className="bg-white p-6 rounded-lg shadow">
                            <h2 className="text-xl font-semibold mb-4 border-b pb-2">C√°c Kho·∫£n C·∫ßn Thu</h2>
                            <ul className="space-y-3 max-h-96 overflow-y-auto">
                                {payments.filter(p => p.status === 'unpaid').map(p => { const tenantInfo = tenants.find(t => t.id === p.tenantId); return (<li key={p.id} className="p-3 bg-yellow-100 rounded-lg"><p className="font-bold">{tenantInfo?.name || 'Kh√¥ng r√µ'}</p><p className="text-lg text-yellow-800 font-semibold">{formatCurrency(p.amount)} VNƒê</p><button onClick={() => onUpdatePaymentStatus(p.id, 'paid')} className="mt-2 w-full btn-primary bg-green-500 hover:bg-green-700">X√°c Nh·∫≠n ƒê√£ Thanh To√°n</button></li>); })}
                                {payments.filter(p => p.status === 'unpaid').length === 0 && <p className="text-gray-500">Kh√¥ng c√≥ kho·∫£n thu n√†o.</p>}
                            </ul>
                        </div>
                    </div>
                    <BottomSheet 
                        show={bottomSheet.show} 
                        onClose={() => setBottomSheet({ ...bottomSheet, show: false })} 
                        title={bottomSheet.title} 
                        data={bottomSheet.data} 
                        type={bottomSheet.type} 
                        onOpenContractModal={(bed) => {
                            onOpenContractModal(bed);
                            setBottomSheet({ ...bottomSheet, show: false });
                        }}
                    />
                </>
            );
        };

        const TenantDirectory = ({ allBeds, tenantsData, buildingsData }) => {
            const [openBuildingId, setOpenBuildingId] = useState(null);

            const directoryData = useMemo(() => {
                const tenantsMap = new Map(tenantsData.map(t => [t.id, t]));
                const buildingsMap = new Map();

                allBeds.forEach(bed => {
                    if (!bed.buildingName || !bed.roomName) return;

                    if (!buildingsMap.has(bed.buildingName)) {
                        const buildingInfo = buildingsData.find(b => b.name === bed.buildingName);
                        buildingsMap.set(bed.buildingName, {
                            id: buildingInfo?.id || bed.buildingName,
                            name: bed.buildingName,
                            rooms: new Map()
                        });
                    }
                    const building = buildingsMap.get(bed.buildingName);

                    if (!building.rooms.has(bed.roomName)) {
                        building.rooms.set(bed.roomName, {
                            id: bed.roomId || `${building.id}_${bed.roomName}`,
                            name: bed.roomName,
                            beds: []
                        });
                    }
                    const room = building.rooms.get(bed.roomName);

                    room.beds.push({
                        ...bed,
                        tenant: bed.tenantId ? tenantsMap.get(bed.tenantId) : null
                    });
                });

                return Array.from(buildingsMap.values()).map(building => ({
                    ...building,
                    rooms: Array.from(building.rooms.values()).sort((a, b) => a.name.localeCompare(b.name))
                }));
            }, [allBeds, tenantsData, buildingsData]);

            const toggleBuilding = (buildingId) => {
                setOpenBuildingId(prevId => (prevId === buildingId ? null : buildingId));
            };

            if (directoryData.length === 0) {
                return <div className="p-8 text-center text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.</div>;
            }

            return (
                <div className="p-4 md:p-8 space-y-4">
                    <h2 className="text-2xl font-bold text-gray-800 mb-6">Danh B·∫° Ng∆∞·ªùi Thu√™ Theo T√≤a Nh√†</h2>
                    {directoryData.map(building => (
                        <div key={building.id} className="bg-white rounded-lg shadow overflow-hidden">
                            <button onClick={() => toggleBuilding(building.id)} className="w-full text-left p-4 bg-gray-50 hover:bg-gray-100 focus:outline-none flex justify-between items-center transition">
                                <h3 className="text-xl font-semibold text-gray-800">{building.name}</h3>
                                <span className={`transform transition-transform duration-300 ${openBuildingId === building.id ? 'rotate-180' : ''}`}>
                                    <svg className="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                                </span>
                            </button>
                            {openBuildingId === building.id && (
                                <div className="p-4 space-y-4 border-t">
                                    {building.rooms.map(room => (
                                        <div key={room.id} className="border rounded-lg p-4 bg-gray-50/50">
                                            <h4 className="text-lg font-bold mb-3 text-blue-700">Ph√≤ng: {room.name}</h4>
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                {room.beds.sort((a,b) => a.name.localeCompare(b.name)).map(bed => (
                                                    <div key={bed.id} className={`p-4 rounded-lg border ${bed.status === 'occupied' ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200'}`}>
                                                        <p className="font-bold text-gray-800">Gi∆∞·ªùng: {bed.name}</p>
                                                        {bed.status === 'occupied' && bed.tenant ? (
                                                            <div className="mt-2 text-sm space-y-1 text-gray-700">
                                                                <p><span className="font-semibold">Ng∆∞·ªùi thu√™:</span> {bed.tenant.name}</p>
                                                                <p><span className="font-semibold">SƒêT:</span> {bed.tenant.phone}</p>
                                                                <p><span className="font-semibold">CCCD:</span> {bed.tenant.idCard || 'N/A'}</p>
                                                                <p><span className="font-semibold">Tr∆∞·ªùng/Vi·ªác:</span> {bed.tenant.school || 'N/A'}</p>
                                                            </div>
                                                        ) : (
                                                            <p className="mt-2 text-sm text-yellow-800 font-semibold">Tr·∫°ng th√°i: Tr·ªëng</p>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            );
        };

        const FinanceManagement = ({ buildingsData, expensesData, paymentsData, tenantsData, onAddExpense, onDeleteExpense }) => {
            const expenseCategories = ["Ti·ªÅn thu√™ nh√†", "Ti·ªÅn ƒëi·ªán", "Ti·ªÅn n∆∞·ªõc", "Ti·ªÅn Internet", "S·ª≠a ch·ªØa", "Ph√≠ v·ªá sinh", "Kh√°c"];
            const [newExpense, setNewExpense] = useState({ 
                category: expenseCategories[0], 
                description: '', 
                amount: '', 
                buildingId: '', 
                date: new Date().toISOString().slice(0, 10) 
            });
            const [filter, setFilter] = useState({ buildingId: 'all', startDate: '', endDate: '' });

            const handleAddExpense = (e) => {
                e.preventDefault();
                if (!newExpense.category || !newExpense.amount || !newExpense.buildingId || !newExpense.date) {
                    alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin.");
                    return;
                }
                if (newExpense.category === 'Kh√°c' && !newExpense.description) {
                    alert("Vui l√≤ng nh·∫≠p n·ªôi dung chi ti·∫øt cho m·ª•c 'Kh√°c'.");
                    return;
                }
                onAddExpense({
                    ...newExpense,
                    amount: parseInt(newExpense.amount, 10),
                    date: Timestamp.fromDate(new Date(newExpense.date))
                });
                setNewExpense({ category: expenseCategories[0], description: '', amount: '', buildingId: '', date: new Date().toISOString().slice(0, 10) });
            };

            const filteredFinancials = useMemo(() => {
                let filteredPayments = paymentsData.filter(p => p.status === 'paid');
                let filteredExpenses = [...expensesData];

                // Filter by Building
                if (filter.buildingId !== 'all') {
                    filteredPayments = filteredPayments.filter(p => p.buildingId === filter.buildingId);
                    filteredExpenses = filteredExpenses.filter(e => e.buildingId === filter.buildingId);
                }

                // Filter by Date
                const start = filter.startDate ? new Date(filter.startDate) : null;
                const end = filter.endDate ? new Date(filter.endDate) : null;
                if(start) start.setHours(0,0,0,0);
                if(end) end.setHours(23,59,59,999);

                if (start) {
                    filteredPayments = filteredPayments.filter(p => p.dueDate.toDate() >= start);
                    filteredExpenses = filteredExpenses.filter(e => e.date.toDate() >= start);
                }
                if (end) {
                    filteredPayments = filteredPayments.filter(p => p.dueDate.toDate() <= end);
                    filteredExpenses = filteredExpenses.filter(e => e.date.toDate() <= end);
                }

                const totalRevenue = filteredPayments.reduce((sum, p) => sum + p.amount, 0);
                const totalExpense = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
                
                const combined = [
                    ...filteredPayments.map(p => ({ ...p, type: 'revenue', date: p.dueDate || p.startDate })),
                    ...filteredExpenses.map(e => ({...e, type: 'expense'}))
                ];
                const transactions = combined.sort((a, b) => b.date.toDate() - a.date.toDate());

                return { totalRevenue, totalExpense, transactions };

            }, [paymentsData, expensesData, filter]);
            
            const chartData = useMemo(() => {
                const monthlyData = {}; 
                const categoryData = {};

                filteredFinancials.transactions.forEach(t => {
                    const month = t.date.toDate().toISOString().slice(0, 7);
                    if (!monthlyData[month]) {
                        monthlyData[month] = { revenue: 0, expense: 0 };
                    }
                    if (t.type === 'revenue') {
                        monthlyData[month].revenue += t.amount;
                    } else {
                        monthlyData[month].expense += t.amount;
                        const category = t.category === 'Kh√°c' && t.description ? t.description : t.category;
                        categoryData[category] = (categoryData[category] || 0) + t.amount;
                    }
                });

                const sortedMonths = Object.keys(monthlyData).sort();
                const columnChartLabels = sortedMonths.map(m => `Th√°ng ${parseInt(m.slice(5), 10)}/${m.slice(0, 4)}`);
                const revenueData = sortedMonths.map(m => monthlyData[m].revenue);
                const expenseData = sortedMonths.map(m => monthlyData[m].expense);

                const pieChartLabels = Object.keys(categoryData);
                const pieChartData = Object.values(categoryData);

                return {
                    column: { labels: columnChartLabels, revenueData, expenseData },
                    pie: { labels: pieChartLabels, data: pieChartData }
                };
            }, [filteredFinancials]);

            return (
                <div className="p-4 md:p-8 space-y-8">
                    <h2 className="text-2xl font-bold text-gray-800">Qu·∫£n L√Ω T√†i Ch√≠nh</h2>
                    
                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="text-xl font-semibold mb-4">B·ªô l·ªçc B√°o c√°o</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">T√≤a nh√†</label>
                                <select value={filter.buildingId} onChange={e => setFilter({...filter, buildingId: e.target.value})} className="input-form mt-1">
                                    <option value="all">T·∫•t c·∫£ c√°c nh√†</option>
                                    {buildingsData.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}
                                </select>
                            </div>
                            <div className="lg:col-span-2">
                                <label className="block text-sm font-medium text-gray-700">Kho·∫£ng th·ªùi gian</label>
                                <div className="flex flex-col sm:flex-row gap-2 mt-1">
                                    <input type="date" value={filter.startDate} onChange={e => setFilter({...filter, startDate: e.target.value})} className="input-form"/>
                                    <input type="date" value={filter.endDate} onChange={e => setFilter({...filter, endDate: e.target.value})} className="input-form"/>
                                    <button onClick={() => setFilter({ buildingId: 'all', startDate: '', endDate: '' })} className="btn-secondary whitespace-nowrap">X√≥a L·ªçc</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="p-6 rounded-lg shadow-lg text-white bg-green-500">
                            <p className="text-lg font-semibold">T·ªïng Doanh Thu</p>
                            <p className="text-4xl font-bold">{formatCurrency(filteredFinancials.totalRevenue)} VNƒê</p>
                            <p className="text-sm opacity-80">Trong kho·∫£ng th·ªùi gian ƒë√£ l·ªçc</p>
                        </div>
                        <div className="p-6 rounded-lg shadow-lg text-white bg-red-500">
                            <p className="text-lg font-semibold">T·ªïng Chi Ph√≠</p>
                            <p className="text-4xl font-bold">{formatCurrency(filteredFinancials.totalExpense)} VNƒê</p>
                            <p className="text-sm opacity-80">Trong kho·∫£ng th·ªùi gian ƒë√£ l·ªçc</p>
                        </div>
                        <div className="p-6 rounded-lg shadow-lg text-white bg-blue-500">
                            <p className="text-lg font-semibold">L·ª£i Nhu·∫≠n ∆Ø·ªõc T√≠nh</p>
                            <p className="text-4xl font-bold">{formatCurrency(filteredFinancials.totalRevenue - filteredFinancials.totalExpense)} VNƒê</p>
                            <p className="text-sm opacity-80">Doanh thu - Chi ph√≠</p>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="text-xl font-semibold mb-4">Bi·ªÉu ƒë·ªì Ph√¢n t√≠ch</h3>
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div>
                                <h4 className="text-lg font-semibold text-center mb-2">Doanh thu vs. Chi ph√≠</h4>
                                <FinanceColumnChart chartData={chartData.column} />
                            </div>
                            <div>
                                <h4 className="text-lg font-semibold text-center mb-2">C∆° c·∫•u Chi ph√≠</h4>
                                <ExpensePieChart chartData={chartData.pie} />
                            </div>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="text-xl font-semibold mb-4">Th√™m Chi Ph√≠ M·ªõi</h3>
                        <form onSubmit={handleAddExpense} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">H·∫°ng m·ª•c chi</label>
                                <select value={newExpense.category} onChange={e => setNewExpense({...newExpense, category: e.target.value, description: ''})} className="input-form mt-1" required>
                                    {expenseCategories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                </select>
                            </div>
                            {newExpense.category === 'Kh√°c' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700">M√¥ t·∫£ chi ti·∫øt</label>
                                    <input type="text" value={newExpense.description} onChange={e => setNewExpense({...newExpense, description: e.target.value})} placeholder="VD: Mua ch·ªïi lau nh√†" className="input-form mt-1" required />
                                </div>
                            )}
                            <div>
                                <label className="block text-sm font-medium text-gray-700">S·ªë ti·ªÅn (VNƒê)</label>
                                <input type="number" value={newExpense.amount} onChange={e => setNewExpense({...newExpense, amount: e.target.value})} placeholder="2000000" className="input-form mt-1" required />
                            </div>
                             <div>
                                <label className="block text-sm font-medium text-gray-700">Ng√†y chi</label>
                                <input type="date" value={newExpense.date} onChange={e => setNewExpense({...newExpense, date: e.target.value})} className="input-form mt-1" required />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Cho t√≤a nh√†</label>
                                <select value={newExpense.buildingId} onChange={e => setNewExpense({...newExpense, buildingId: e.target.value})} className="input-form mt-1" required>
                                    <option value="">-- Ch·ªçn t√≤a nh√† --</option>
                                    {buildingsData.map(b => <option key={b.id} value={b.id}>{b.name}</option>)}
                                </select>
                            </div>
                            <div className="lg:col-span-2">
                                <button type="submit" className="btn-primary w-full">Th√™m Chi Ph√≠</button>
                            </div>
                        </form>
                    </div>

                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="text-xl font-semibold mb-4">L·ªãch S·ª≠ Giao D·ªãch</h3>
                        <div className="max-h-96 overflow-y-auto">
                            <ul className="space-y-2">
                                {filteredFinancials.transactions.map(item => (
                                    <li key={item.id} className={`group p-3 rounded-lg flex justify-between items-center ${item.type === 'revenue' ? 'bg-green-50' : 'bg-red-50'}`}>
                                        <div>
                                            <p className="font-bold">{item.type === 'revenue' ? `Thu t·ª´ ${tenantsData.find(t => t.id === item.tenantId)?.name || 'N/A'}` : (item.category === 'Kh√°c' ? item.description : item.category)}</p>
                                            <p className="text-sm text-gray-500">{formatDate(item.date)} - {item.type === 'expense' ? `Nh√†: ${buildingsData.find(b => b.id === item.buildingId)?.name || 'N/A'}` : `Ph√≤ng: ${item.roomName}`}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className={`font-semibold ${item.type === 'revenue' ? 'text-green-600' : 'text-red-600'}`}>
                                                {item.type === 'revenue' ? '+' : '-'} {formatCurrency(item.amount)} VNƒê
                                            </p>
                                            {item.type === 'expense' && (
                                                <button onClick={() => onDeleteExpense(item.id)} className="text-xs text-gray-500 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity">X√≥a</button>
                                            )}
                                        </div>
                                    </li>
                                ))}
                                {filteredFinancials.transactions.length === 0 && <p className="text-gray-500 text-center py-4">Ch∆∞a c√≥ giao d·ªãch n√†o.</p>}
                            </ul>
                        </div>
                    </div>
                </div>
            );
        };

        const EditableListItem = ({ item, onUpdate, onDelete, isSelected, onClick, children }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [name, setName] = useState(item.name);

            const handleSave = () => {
                if (name.trim() !== '' && name.trim() !== item.name) {
                    onUpdate(item.id, name.trim());
                }
                setIsEditing(false);
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') handleSave();
                if (e.key === 'Escape') {
                    setName(item.name);
                    setIsEditing(false);
                }
            };

            return (
                <li onClick={onClick} className={`group p-2 rounded cursor-pointer transition-all flex justify-between items-center ${isSelected ? 'bg-blue-500 text-white shadow-lg' : 'bg-gray-100 hover:bg-blue-100'}`}>
                    <div className="flex items-center flex-grow">
                        {isEditing ? (
                            <input type="text" value={name} onChange={e => setName(e.target.value)} onBlur={handleSave} onKeyDown={handleKeyDown} autoFocus className="input-form text-black p-1 flex-grow"/>
                        ) : (
                            <span className="flex-grow">{item.name}</span>
                        )}
                        {item.isWholeUnit && (
                            <span title="Cho thu√™ nguy√™n cƒÉn" className="ml-2 text-gray-500">üè¢</span>
                        )}
                    </div>
                    <div className="hidden group-hover:flex items-center gap-2 pl-2">
                        <button onClick={(e) => { e.stopPropagation(); setIsEditing(true); }} className="text-sm text-blue-600 hover:text-blue-800">S·ª≠a</button>
                        <button onClick={(e) => { e.stopPropagation(); onDelete(item); }} className="text-sm text-red-600 hover:text-red-800">X√≥a</button>
                    </div>
                    {children}
                </li>
            );
        };

        const Management = ({ 
            onAddBuilding, onAddRoom, onAddBed, onOpenAddTenantModal, onOpenContractModal,
            onUpdateItem, onDeleteItem, onUpdateTenant, onDeletePayment, onOpenEditTenantModal,
            newBuildingName, setNewBuildingName,
            newRoomName, setNewRoomName,
            newBedName, setNewBedName,
            buildingsData, tenantsData, paymentsData
        }) => {
            const [selectedBuilding, setSelectedBuilding] = useState(null);
            const [selectedRoom, setSelectedRoom] = useState(null);
            const [newRoomIsWholeUnit, setNewRoomIsWholeUnit] = useState(false);
            
            const useSubCollection = (parentCollection, parentId, subCollectionName) => {
                const [data, setData] = useState([]);
                useEffect(() => {
                    if (!parentId) { setData([]); return; }
                    const q = db.collection(parentCollection).doc(parentId).collection(subCollectionName);
                    const unsubscribe = q.onSnapshot((querySnapshot) => {
                        const items = [];
                        querySnapshot.forEach((doc) => {
                            items.push({ 
                                id: doc.id, 
                                ...doc.data(),
                                path: doc.ref.path
                            });
                        });
                        setData(items);
                    });
                    return () => unsubscribe();
                }, [parentId, subCollectionName]);
                return data;
            };

            const roomsData = useSubCollection('buildings', selectedBuilding?.id, 'rooms');
            const [bedsData, setBedsData] = useState([]);

            useEffect(() => {
                if (!selectedRoom?.id || !selectedBuilding?.id || selectedRoom.isWholeUnit) {
                    setBedsData([]);
                    return;
                }
                const path = `buildings/${selectedBuilding.id}/rooms/${selectedRoom.id}/beds`;
                const q = db.collection(path);
                const unsubscribe = q.onSnapshot((querySnapshot) => {
                    let items = [];
                    querySnapshot.forEach((doc) => {
                        items.push({ 
                            id: doc.id, 
                            ...doc.data(),
                            path: doc.ref.path,
                            roomId: selectedRoom.id,
                            buildingId: selectedBuilding.id,
                            roomName: selectedRoom.name,
                            buildingName: selectedBuilding.name
                        });
                    });
                    items.sort((a, b) => a.name.localeCompare(b.name));
                    setBedsData(items);
                });
                return () => unsubscribe();
            }, [selectedRoom, selectedBuilding]);

            const handleAddRoomInternal = (e) => {
                e.preventDefault();
                onAddRoom(e, selectedBuilding.id, newRoomIsWholeUnit);
                setNewRoomIsWholeUnit(false);
            };

            const handleAddBedInternal = (e) => { e.preventDefault(); if(!selectedRoom || !selectedBuilding) return; onAddBed(e, selectedRoom.id, selectedBuilding.id, selectedBuilding.name, selectedRoom.name); }

            return (
                <div className="p-4 md:p-8">
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2 bg-white p-6 rounded-lg shadow">
                            <h2 className="text-xl font-semibold mb-4 border-b pb-2">S∆° ƒê·ªì Qu·∫£n L√Ω</h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div>
                                    <h3 className="font-bold text-lg mb-2">1. CƒÉn Nh√†</h3>
                                    <form onSubmit={onAddBuilding} className="flex gap-2 mb-4"><input type="text" value={newBuildingName} onChange={e => setNewBuildingName(e.target.value)} placeholder="T√™n nh√† m·ªõi" className="input-form flex-grow"/><button type="submit" className="btn-primary">+</button></form>
                                    <ul className="space-y-2">{buildingsData.map(b => (<EditableListItem key={b.id} item={b} onUpdate={(id, name) => onUpdateItem('buildings', id, name)} onDelete={(item) => onDeleteItem('building', item)} isSelected={selectedBuilding?.id === b.id} onClick={() => { setSelectedBuilding(b); setSelectedRoom(null); }} />))}</ul>
                                </div>
                                <div>
                                    <h3 className="font-bold text-lg mb-2">2. Ph√≤ng</h3>
                                    {selectedBuilding && (<>
                                        <form onSubmit={handleAddRoomInternal} className="mb-4">
                                            <div className="flex gap-2">
                                                <input type="text" value={newRoomName} onChange={e => setNewRoomName(e.target.value)} placeholder="T√™n ph√≤ng m·ªõi" className="input-form flex-grow"/>
                                                <button type="submit" className="btn-primary">+</button>
                                            </div>
                                            <div className="flex items-center mt-2">
                                                <input id="is-whole-unit" type="checkbox" checked={newRoomIsWholeUnit} onChange={e => setNewRoomIsWholeUnit(e.target.checked)} className="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" />
                                                <label htmlFor="is-whole-unit" className="ml-2 block text-sm text-gray-900">Cho thu√™ nguy√™n cƒÉn?</label>
                                            </div>
                                        </form>
                                        <ul className="space-y-2">{roomsData.map(r => (
                                            <EditableListItem key={r.id} item={r} onUpdate={(id, name) => onUpdateItem(`buildings/${selectedBuilding.id}/rooms`, id, name)} onDelete={(item) => onDeleteItem('room', item, selectedBuilding.id)} isSelected={selectedRoom?.id === r.id} onClick={() => setSelectedRoom(r)}>
                                                {r.isWholeUnit && r.status !== 'occupied' && 
                                                    <button onClick={(e) => { 
                                                        e.stopPropagation(); 
                                                        onOpenContractModal({
                                                            ...r,
                                                            buildingId: selectedBuilding.id,
                                                            buildingName: selectedBuilding.name
                                                        }); 
                                                    }} className="btn-secondary text-xs ml-auto">T·∫°o Hƒê</button>
                                                }
                                                {r.isWholeUnit && r.status === 'occupied' && <span className="text-xs font-semibold text-red-700 ml-auto">ƒê√£ thu√™</span>}
                                            </EditableListItem>
                                        ))}</ul>
                                    </>)}
                                </div>
                                <div>
                                    <h3 className="font-bold text-lg mb-2">3. Gi∆∞·ªùng</h3>
                                    {selectedRoom && !selectedRoom.isWholeUnit && (<>
                                        <form onSubmit={handleAddBedInternal} className="flex gap-2 mb-4"><input type="text" value={newBedName} onChange={e => setNewBedName(e.target.value)} placeholder="T√™n gi∆∞·ªùng m·ªõi" className="input-form flex-grow"/><button type="submit" className="btn-primary">+</button></form>
                                        <ul className="space-y-2">{bedsData.map(bed => (<EditableListItem key={bed.id} item={bed} onUpdate={(id, name) => onUpdateItem(bed.path, id, name)} onDelete={(item) => onDeleteItem('bed', item, { buildingId: selectedBuilding.id, roomId: selectedRoom.id })}>
                                            {bed.status === 'available' ? <button onClick={(e) => { e.stopPropagation(); onOpenContractModal(bed); }} className="btn-secondary text-xs ml-auto">T·∫°o Hƒê</button> : <span className="text-xs font-semibold text-red-700 ml-auto">ƒê√£ thu√™</span>}
                                        </EditableListItem>))}</ul>
                                    </>)}
                                    {selectedRoom && selectedRoom.isWholeUnit && (
                                        <div className="p-4 bg-gray-100 rounded-lg text-center text-gray-600">
                                            Ph√≤ng n√†y ƒë∆∞·ª£c cho thu√™ nguy√™n cƒÉn.
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                        <div className="space-y-8">
                            <div className="bg-white p-6 rounded-lg shadow">
                                <div className="flex justify-between items-center mb-4 border-b pb-2"><h2 className="text-xl font-semibold">Ng∆∞·ªùi Thu√™</h2><button onClick={onOpenAddTenantModal} className="btn-primary">Th√™m Ng∆∞·ªùi Thu√™</button></div>
                                <ul className="space-y-2 max-h-60 overflow-y-auto">{tenantsData.map(t => (<li key={t.id} className="group p-2 bg-gray-50 rounded flex justify-between items-center"><div className="flex-grow"><p className="font-bold">{t.name}</p><p className="text-sm text-gray-600">{t.phone} - {t.school}</p></div><div className="hidden group-hover:flex items-center gap-2 pl-2"><button onClick={() => onOpenEditTenantModal(t)} className="text-sm text-blue-600 hover:text-blue-800">S·ª≠a</button><button onClick={() => onDeleteItem('tenant', t)} className="text-sm text-red-600 hover:text-red-800">X√≥a</button></div></li>))}</ul>
                            </div>
                            <div className="bg-white p-6 rounded-lg shadow">
                                <h2 className="text-xl font-semibold mb-4 border-b pb-2">C√°c Kho·∫£n ƒê√£ Thanh To√°n</h2>
                                <ul className="space-y-3 max-h-80 overflow-y-auto">{paymentsData.filter(p => p.status === 'paid').map(p => { const tenantInfo = tenantsData.find(t => t.id === p.tenantId); return (<li key={p.id} className="group p-3 bg-green-100 rounded-lg opacity-70 flex justify-between items-center"><div className="flex-grow"><p className="font-bold">{tenantInfo?.name || 'Kh√¥ng r√µ'}</p><p className="text-md text-green-800 font-semibold">{formatCurrency(p.amount)} VNƒê</p></div><button onClick={() => onDeletePayment(p.id)} className="hidden group-hover:block text-sm text-red-600 hover:text-red-800 ml-2">X√≥a</button></li>);})}{paymentsData.filter(p => p.status === 'paid').length === 0 && <p className="text-gray-500">Ch∆∞a c√≥ thanh to√°n n√†o.</p>}</ul>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ isOpen, view, setView, onClose }) => {
            const navItems = [
                { id: 'dashboard', label: 'Dashboard' },
                { id: 'finance', label: 'T√†i Ch√≠nh' },
                { id: 'directory', label: 'Danh B·∫° Thu√™' },
                { id: 'management', label: 'Qu·∫£n L√Ω Chi Ti·∫øt' },
            ];

            return (
                <>
                    <div className={`fixed inset-0 bg-black bg-opacity-50 z-40 transition-opacity md:hidden ${isOpen ? 'opacity-100' : 'opacity-0 pointer-events-none'}`} onClick={onClose}></div>
                    <div className={`fixed top-0 left-0 h-full bg-white w-64 z-50 transform transition-transform md:hidden ${isOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-4">
                             <h1 className="text-2xl font-bold text-blue-600">H4Rent</h1>
                        </div>
                        <nav className="mt-4">
                            {navItems.map(item => (
                                <button 
                                    key={item.id}
                                    onClick={() => { setView(item.id); onClose(); }} 
                                    className={`w-full text-left p-4 text-lg font-semibold ${view === item.id ? 'bg-blue-100 text-blue-700' : 'text-gray-600 hover:bg-gray-100'}`}
                                >
                                    {item.label}
                                </button>
                            ))}
                        </nav>
                    </div>
                </>
            );
        };

        const Header = ({ view, setView, onLogout, userEmail, onToggleSidebar, onOpenAddTenantModal }) => {
            const navItems = [
                { id: 'dashboard', label: 'Dashboard' },
                { id: 'finance', label: 'T√†i Ch√≠nh' },
                { id: 'directory', label: 'Danh B·∫° Thu√™' },
                { id: 'management', label: 'Qu·∫£n L√Ω Chi Ti·∫øt' },
            ];

            return (
                <header className="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-30">
                    <div className="flex items-center gap-2 md:gap-8">
                        <button onClick={onToggleSidebar} className="p-2 md:hidden">
                             <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                        <h1 className="text-2xl font-bold text-blue-600">H4Rent</h1>
                        <nav className="hidden md:flex gap-4">
                            {navItems.map(item => (
                                <button key={item.id} onClick={() => setView(item.id)} className={`pb-1 font-semibold ${view === item.id ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>{item.label}</button>
                            ))}
                        </nav>
                    </div>
                    <div className="flex items-center gap-2">
                        <button onClick={onOpenAddTenantModal} className="p-2 md:hidden text-gray-600 hover:text-blue-600">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                        </button>
                        <span className="text-gray-700 mr-2 hidden sm:inline">Ch√†o, {userEmail}</span>
                        <button onClick={onLogout} className="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">ƒêƒÉng Xu·∫•t</button>
                    </div>
                </header>
            );
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('dashboard');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [confirmModal, setConfirmModal] = useState({ show: false, title: '', message: '', onConfirm: () => {} });

            const [newBuildingName, setNewBuildingName] = useState('');
            const [newRoomName, setNewRoomName] = useState('');
            const [newBedName, setNewBedName] = useState('');

            // State for Modals (lifted up)
            const [showContractModal, setShowContractModal] = useState(false);
            const [showAddTenantModal, setShowAddTenantModal] = useState(false);
            const [showEditTenantModal, setShowEditTenantModal] = useState(false);

            // State for Modal Data
            const [contractData, setContractData] = useState({ bedId: null, tenantId: '', paymentCycle: '3', rentPrice: '2000000' });
            const [newTenant, setNewTenant] = useState({ name: '', phone: '', idCard: '', school: '' });
            const [editingTenant, setEditingTenant] = useState(null);

            // State for Gemini feature
            const [generatedContractText, setGeneratedContractText] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);
            const [copySuccess, setCopySuccess] = useState('');

            const useCollection = (collectionName) => {
                const [data, setData] = useState([]);
                useEffect(() => {
                    if (!user) { setData([]); return; }
                    const q = db.collection(collectionName);
                    const unsubscribe = q.onSnapshot((querySnapshot) => {
                        const items = [];
                        querySnapshot.forEach((doc) => items.push({ id: doc.id, ...doc.data() }));
                        setData(items);
                    });
                    return () => unsubscribe();
                }, [user, collectionName]);
                return data;
            };

            const useCollectionGroup = (collectionId) => {
                const [data, setData] = useState([]);
                useEffect(() => {
                    if (!user) { setData([]); return; }
                    const q = db.collectionGroup(collectionId);
                    const unsubscribe = q.onSnapshot((querySnapshot) => {
                        const items = [];
                        querySnapshot.forEach((doc) => {
                            const bedData = doc.data();
                            bedData.path = doc.ref.path;
                            items.push({ id: doc.id, ...bedData });
                        });
                        setData(items);
                    });
                    return () => unsubscribe();
                }, [user, collectionId]);
                return data;
            };
            
            const buildingsData = useCollection('buildings');
            const tenantsData = useCollection('tenants');
            const paymentsData = useCollection('payments');
            const contractsData = useCollection('contracts');
            const allBedsData = useCollectionGroup('beds');
            const expensesData = useCollection('expenses');

            const availableTenants = useMemo(() => {
                const occupiedTenantIds = new Set(
                    allBedsData
                        .filter(bed => bed.status === 'occupied' && bed.tenantId)
                        .map(bed => bed.tenantId)
                );
                return tenantsData.filter(tenant => !occupiedTenantIds.has(tenant.id));
            }, [tenantsData, allBedsData]);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleUpdateItem = async (path, id, newName) => {
                const itemRef = db.doc(`${path}/${id}`);
                await itemRef.update({ name: newName });
            };
            
            const handleUpdateTenant = async (tenantId, updatedData) => {
                const tenantRef = db.collection('tenants').doc(tenantId);
                await tenantRef.update(updatedData);
                setShowEditTenantModal(false);
                setEditingTenant(null);
            };

            const handleDeletePayment = (paymentId) => {
                const onConfirm = async () => {
                    await db.collection('payments').doc(paymentId).delete();
                    setConfirmModal({ show: false });
                };
                setConfirmModal({ show: true, title: 'X√°c nh·∫≠n x√≥a thanh to√°n', message: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kho·∫£n thanh to√°n n√†y?', onConfirm });
            };

            const handleDeleteItem = (type, item, parentData = null) => {
                const onConfirm = async () => {
                    try {
                        if (type === 'bed') {
                            if (item.status === 'occupied') { alert('Kh√¥ng th·ªÉ x√≥a gi∆∞·ªùng ƒë√£ c√≥ ng∆∞·ªùi thu√™.'); return; }
                            if (!parentData?.buildingId || !parentData?.roomId) {
                                alert('Kh√¥ng th·ªÉ x√≥a gi∆∞·ªùng, thi·∫øu th√¥ng tin ph√≤ng/nh√†.');
                                return;
                            }
                            await db.doc(`buildings/${parentData.buildingId}/rooms/${parentData.roomId}/beds/${item.id}`).delete();
                        } else if (type === 'room') {
                            const buildingId = parentData;
                            const batch = db.batch();
                            const roomRef = db.doc(`buildings/${buildingId}/rooms/${item.id}`);
                            const bedsQuery = db.collection(`buildings/${buildingId}/rooms/${item.id}/beds`);
                            const bedsSnapshot = await bedsQuery.get();
                            bedsSnapshot.forEach(bedDoc => batch.delete(bedDoc.ref));
                            batch.delete(roomRef);
                            await batch.commit();
                        } else if (type === 'building') {
                            const batch = db.batch();
                            const buildingRef = db.collection('buildings').doc(item.id);
                            const roomsQuery = db.collection(`buildings/${item.id}/rooms`);
                            const roomsSnapshot = await roomsQuery.get();
                            for (const roomDoc of roomsSnapshot.docs) {
                                const bedsQuery = db.collection(`buildings/${roomDoc.id}/rooms/${roomDoc.id}/beds`);
                                const bedsSnapshot = await bedsQuery.get();
                                bedsSnapshot.forEach(bedDoc => batch.delete(bedDoc.ref));
                                batch.delete(roomDoc.ref);
                            }
                            batch.delete(buildingRef);
                            await batch.commit();
                        } else if (type === 'tenant') {
                            const bedsQuery = db.collectionGroup('beds').where('tenantId', '==', item.id);
                            const bedsSnapshot = await bedsQuery.get();
                            if (!bedsSnapshot.empty) {
                                alert('Kh√¥ng th·ªÉ x√≥a ng∆∞·ªùi thu√™ ƒëang c√≥ h·ª£p ƒë·ªìng. Vui l√≤ng k·∫øt th√∫c h·ª£p ƒë·ªìng tr∆∞·ªõc.');
                                return;
                            }
                            await db.collection('tenants').doc(item.id).delete();
                        }
                    } catch (error) {
                        console.error("L·ªói khi x√≥a:", error);
                        alert("ƒê√£ c√≥ l·ªói x·∫£y ra khi x√≥a.");
                    } finally {
                        setConfirmModal({ show: false, title: '', message: '', onConfirm: () => {} });
                    }
                };
                setConfirmModal({ show: true, title: `X√°c nh·∫≠n x√≥a`, message: `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a "${item.name}"? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`, onConfirm });
            };

            const handleAddBuilding = async (e) => { e.preventDefault(); if (newBuildingName.trim() === '') return; await db.collection('buildings').add({ name: newBuildingName, createdAt: Timestamp.now() }); setNewBuildingName(''); };
            
            const handleAddRoom = async (e, buildingId, isWholeUnit) => { 
                e.preventDefault(); 
                if (newRoomName.trim() === '' || !buildingId) return; 
                await db.collection('buildings').doc(buildingId).collection('rooms').add({ 
                    name: newRoomName, 
                    isWholeUnit: isWholeUnit,
                    status: 'available',
                    createdAt: Timestamp.now() 
                }); 
                setNewRoomName(''); 
            };
            
            const handleAddBed = async (e, roomId, buildingId, buildingName, roomName) => { e.preventDefault(); if (newBedName.trim() === '' || !roomId || !buildingId) return; await db.collection('buildings').doc(buildingId).collection('rooms').doc(roomId).collection('beds').add({ name: newBedName, status: 'available', tenantId: null, createdAt: Timestamp.now(), buildingId, roomId, buildingName, roomName }); setNewBedName(''); };
            
            const handleAddTenant = async (tenantData) => { 
                if (tenantData.name.trim() === '' || tenantData.phone.trim() === '') return; 
                await db.collection('tenants').add(tenantData); 
                setNewTenant({ name: '', phone: '', idCard: '', school: '' });
                setShowAddTenantModal(false);
            };
            
            const handleAddExpense = async (expenseData) => {
                await db.collection('expenses').add({ ...expenseData, createdAt: Timestamp.now() });
            };
            
            const handleDeleteExpense = (expenseId) => {
                const onConfirm = async () => {
                    await db.collection('expenses').doc(expenseId).delete();
                    setConfirmModal({ show: false });
                };
                setConfirmModal({ show: true, title: 'X√°c nh·∫≠n x√≥a chi ph√≠', message: 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kho·∫£n chi ph√≠ n√†y?', onConfirm });
            };

            const handleCreateContract = async (contractDataPayload) => { 
                if(!contractDataPayload.tenantId || !contractDataPayload.itemId) { 
                    alert("Vui l√≤ng ch·ªçn ng∆∞·ªùi thu√™!"); 
                    return; 
                } 
                if(!contractDataPayload.itemPath) {
                    alert("L·ªói: Kh√¥ng t√¨m th·∫•y ƒë∆∞·ªùng d·∫´n c·ªßa ph√≤ng/gi∆∞·ªùng. Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i.");
                    return;
                }
                try { 
                    const contractRef = await db.collection('contracts').add({ ...contractDataPayload, startDate: Timestamp.now() }); 
                    const amount = parseInt(contractDataPayload.rentPrice) * parseInt(contractDataPayload.paymentCycle); 
                    await db.collection('payments').add({ 
                        contractId: contractRef.id, 
                        tenantId: contractDataPayload.tenantId, 
                        amount: amount, 
                        dueDate: Timestamp.now(), 
                        status: 'unpaid',
                        buildingId: contractDataPayload.buildingId,
                        buildingName: contractDataPayload.buildingName,
                        roomName: contractDataPayload.roomName
                    }); 
                    
                    const itemRef = db.doc(contractDataPayload.itemPath); 
                    await itemRef.update({ status: 'occupied', tenantId: contractDataPayload.tenantId }); 
                    
                    setShowContractModal(false);
                    setContractData({ bedId: null, tenantId: '', paymentCycle: '3', rentPrice: '2000000' });
                } catch (error) { 
                    console.error("L·ªói t·∫°o h·ª£p ƒë·ªìng:", error); 
                    alert("ƒê√£ c√≥ l·ªói x·∫£y ra khi t·∫°o h·ª£p ƒë·ªìng."); 
                }
            };
            
            const handleUpdatePaymentStatus = async (paymentId, newStatus) => { const paymentRef = db.collection('payments').doc(paymentId); await paymentRef.update({ status: newStatus }); };
            const handleLogout = () => { auth.signOut(); };

            const handleOpenContractModal = (item) => {
                const isRoom = !!item.isWholeUnit;
                const itemForContract = { ...item };

                if (!itemForContract.buildingId && itemForContract.buildingName) {
                    const building = buildingsData.find(b => b.name === itemForContract.buildingName);
                    if (building) {
                        itemForContract.buildingId = building.id;
                    }
                }
                
                if (!itemForContract.id || !itemForContract.path) {
                    alert('Th√¥ng tin ph√≤ng/gi∆∞·ªùng kh√¥ng ƒë·∫ßy ƒë·ªß ƒë·ªÉ t·∫°o h·ª£p ƒë·ªìng. Thi·∫øu ID ho·∫∑c ƒë∆∞·ªùng d·∫´n.');
                    console.error('Invalid item data for contract:', itemForContract);
                    return;
                }

                setContractData({
                    itemId: itemForContract.id,
                    itemType: isRoom ? 'room' : 'bed',
                    roomId: isRoom ? itemForContract.id : itemForContract.roomId,
                    buildingId: itemForContract.buildingId,
                    buildingName: itemForContract.buildingName,
                    roomName: isRoom ? itemForContract.name : itemForContract.roomName,
                    tenantId: '',
                    paymentCycle: '3',
                    rentPrice: isRoom ? '15000000' : '2000000',
                    itemPath: itemForContract.path
                });
                setShowContractModal(true);
            };

            const handleOpenAddTenantModal = () => {
                setNewTenant({ name: '', phone: '', idCard: '', school: '' });
                setShowAddTenantModal(true);
            };

            const handleOpenEditTenantModal = (tenant) => {
                setEditingTenant(tenant);
                setShowEditTenantModal(true);
            };

            const handleGenerateContractText = async () => {
                if (!contractData.tenantId || !contractData.itemId) {
                    alert("Vui l√≤ng ch·ªçn ng∆∞·ªùi thu√™ v√† ph√≤ng/gi∆∞·ªùng tr∆∞·ªõc khi so·∫°n th·∫£o.");
                    return;
                }
                setIsGenerating(true);
                setGeneratedContractText('');
                setCopySuccess('');

                const tenant = tenantsData.find(t => t.id === contractData.tenantId);
                const itemName = contractData.itemType === 'room' ? contractData.roomName : allBedsData.find(b => b.id === contractData.itemId)?.name;
                
                const prompt = `
                    H√£y so·∫°n th·∫£o c√°c ƒëi·ªÅu kho·∫£n h·ª£p ƒë·ªìng cho thu√™ nh√† ƒë∆°n gi·∫£n b·∫±ng ti·∫øng Vi·ªát cho c√°c th√¥ng tin sau:
                    - T√™n ng∆∞·ªùi thu√™: ${tenant?.name}
                    - S·ªë ƒëi·ªán tho·∫°i: ${tenant?.phone}
                    - ƒê·ªëi t∆∞·ª£ng thu√™: ${contractData.itemType === 'room' ? `Ph√≤ng ${itemName}` : `Gi∆∞·ªùng ${itemName}`}
                    - Thu·ªôc ph√≤ng: ${contractData.roomName}
                    - T·∫°i nh√†: ${contractData.buildingName}
                    - Gi√° thu√™ h√†ng th√°ng: ${formatCurrency(contractData.rentPrice)} VNƒê
                    - K·ª≥ thanh to√°n: ${contractData.paymentCycle} th√°ng m·ªôt l·∫ßn
                    - T·ªïng ti·ªÅn thanh to√°n m·ªói k·ª≥: ${formatCurrency(parseInt(contractData.rentPrice) * parseInt(contractData.paymentCycle))} VNƒê

                    N·ªôi dung c·∫ßn bao g·ªìm c√°c m·ª•c ch√≠nh sau:
                    1. Th√¥ng tin c√°c b√™n.
                    2. ƒê·ªëi t∆∞·ª£ng h·ª£p ƒë·ªìng.
                    3. Gi√° thu√™ v√† ph∆∞∆°ng th·ª©c thanh to√°n.
                    4. Th·ªùi h·∫°n h·ª£p ƒë·ªìng.
                    5. Quy·ªÅn v√† nghƒ©a v·ª• c·ªßa c√°c b√™n.
                    6. ƒêi·ªÅu kho·∫£n chung v√† ch·ªØ k√Ω.

                    Vui l√≤ng tr√¨nh b√†y r√µ r√†ng, chuy√™n nghi·ªáp v√† d·ªÖ hi·ªÉu.
                `;

                try {
                    const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = ""; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                    const result = await response.json();

                    if (result.candidates?.[0]?.content?.parts?.[0]) {
                        setGeneratedContractText(result.candidates[0].content.parts[0].text);
                    } else {
                        console.error("Unexpected API response structure:", result);
                        setGeneratedContractText("Kh√¥ng th·ªÉ t·∫°o n·ªôi dung h·ª£p ƒë·ªìng. Ph·∫£n h·ªìi t·ª´ API kh√¥ng h·ª£p l·ªá.");
                    }
                } catch (error) {
                    console.error("L·ªói khi g·ªçi Gemini API:", error);
                    setGeneratedContractText("ƒê√£ c√≥ l·ªói x·∫£y ra khi t·∫°o n·ªôi dung h·ª£p ƒë·ªìng. Vui l√≤ng th·ª≠ l·∫°i.");
                } finally {
                    setIsGenerating(false);
                }
            };

            const copyToClipboard = (text) => {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    setCopySuccess('ƒê√£ sao ch√©p!');
                    setTimeout(() => setCopySuccess(''), 2000);
                } catch (err) {
                    setCopySuccess('Sao ch√©p th·∫•t b·∫°i!');
                    console.error('Kh√¥ng th·ªÉ sao ch√©p: ', err);
                }
                document.body.removeChild(textArea);
            };

            if (loading) return <div className="min-h-screen flex items-center justify-center">ƒêang t·∫£i...</div>;
            if (!user) return <LoginScreen />;

            return (
                <div className="bg-gray-50 min-h-screen">
                    <Sidebar 
                        isOpen={isSidebarOpen}
                        onClose={() => setIsSidebarOpen(false)}
                        view={view}
                        setView={setView}
                    />
                    <Header
                        view={view}
                        setView={setView}
                        onLogout={handleLogout}
                        userEmail={user.email}
                        onToggleSidebar={() => setIsSidebarOpen(!isSidebarOpen)}
                        onOpenAddTenantModal={handleOpenAddTenantModal}
                    />
                    <main>
                        {view === 'dashboard' && <Dashboard allBeds={allBedsData} tenants={tenantsData} contracts={contractsData} payments={paymentsData} buildingsData={buildingsData} onUpdatePaymentStatus={handleUpdatePaymentStatus} onOpenContractModal={handleOpenContractModal} />}
                        {view === 'finance' && <FinanceManagement tenantsData={tenantsData} buildingsData={buildingsData} expensesData={expensesData} paymentsData={paymentsData} onAddExpense={handleAddExpense} onDeleteExpense={handleDeleteExpense} />}
                        {view === 'directory' && <TenantDirectory allBeds={allBedsData} tenantsData={tenantsData} buildingsData={buildingsData} />}
                        {view === 'management' && <Management onAddBuilding={handleAddBuilding} onAddRoom={handleAddRoom} onAddBed={handleAddBed} onOpenAddTenantModal={handleOpenAddTenantModal} onOpenContractModal={handleOpenContractModal} onUpdateItem={handleUpdateItem} onDeleteItem={handleDeleteItem} onUpdateTenant={handleUpdateTenant} onDeletePayment={handleDeletePayment} onOpenEditTenantModal={handleOpenEditTenantModal} newBuildingName={newBuildingName} setNewBuildingName={setNewBuildingName} newRoomName={newRoomName} setNewRoomName={setNewRoomName} newBedName={newBedName} setNewBedName={setNewBedName} buildingsData={buildingsData} tenantsData={tenantsData} paymentsData={paymentsData}/>}
                    </main>
                    <ConfirmationModal show={confirmModal.show} onClose={() => setConfirmModal({ show: false })} onConfirm={confirmModal.onConfirm} title={confirmModal.title} message={confirmModal.message} />
                    
                    <Modal show={showAddTenantModal} onClose={() => setShowAddTenantModal(false)} title="Th√™m Ng∆∞·ªùi Thu√™ M·ªõi">
                        <form onSubmit={(e) => { e.preventDefault(); handleAddTenant(newTenant); }}>
                            <div className="space-y-4">
                                <input value={newTenant.name} onChange={e => setNewTenant({...newTenant, name: e.target.value})} placeholder="H·ªç v√† T√™n" className="input-form w-full" required/>
                                <input value={newTenant.phone} onChange={e => setNewTenant({...newTenant, phone: e.target.value})} placeholder="S·ªë ƒëi·ªán tho·∫°i" className="input-form w-full" required/>
                                <input value={newTenant.idCard} onChange={e => setNewTenant({...newTenant, idCard: e.target.value})} placeholder="S·ªë CCCD" className="input-form w-full"/>
                                <input value={newTenant.school} onChange={e => setNewTenant({...newTenant, school: e.target.value})} placeholder="Tr∆∞·ªùng h·ªçc/N∆°i l√†m vi·ªác" className="input-form w-full"/>
                                <button type="submit" className="btn-primary w-full">L∆∞u</button>
                            </div>
                        </form>
                    </Modal>

                    {editingTenant && (
                        <Modal show={showEditTenantModal} onClose={() => setShowEditTenantModal(false)} title="S·ª≠a Th√¥ng Tin Ng∆∞·ªùi Thu√™">
                            <form onSubmit={(e) => { e.preventDefault(); handleUpdateTenant(editingTenant.id, editingTenant); }}>
                                <div className="space-y-4">
                                    <input value={editingTenant.name} onChange={e => setEditingTenant({...editingTenant, name: e.target.value})} placeholder="H·ªç v√† T√™n" className="input-form w-full" required/>
                                    <input value={editingTenant.phone} onChange={e => setEditingTenant({...editingTenant, phone: e.target.value})} placeholder="S·ªë ƒëi·ªán tho·∫°i" className="input-form w-full" required/>
                                    <input value={editingTenant.idCard} onChange={e => setEditingTenant({...editingTenant, idCard: e.target.value})} placeholder="S·ªë CCCD" className="input-form w-full"/>
                                    <input value={editingTenant.school} onChange={e => setEditingTenant({...editingTenant, school: e.target.value})} placeholder="Tr∆∞·ªùng h·ªçc/N∆°i l√†m vi·ªác" className="input-form w-full"/>
                                    <button type="submit" className="btn-primary w-full">C·∫≠p Nh·∫≠t</button>
                                </div>
                            </form>
                        </Modal>
                    )}

                    <Modal show={showContractModal} onClose={() => {setShowContractModal(false); setGeneratedContractText(''); setCopySuccess('');}} title="T·∫°o H·ª£p ƒê·ªìng M·ªõi">
                        <form onSubmit={(e) => {e.preventDefault(); handleCreateContract(contractData);}}>
                            <div className="space-y-4">
                                <div><label className="block text-sm font-medium text-gray-700">Ch·ªçn ng∆∞·ªùi thu√™</label><select value={contractData.tenantId} onChange={e => setContractData({...contractData, tenantId: e.target.value})} className="input-form w-full" required><option value="">-- Ch·ªçn --</option>{availableTenants.length > 0 ? availableTenants.map(t => <option key={t.id} value={t.id}>{t.name} - {t.phone}</option>) : <option disabled>Kh√¥ng c√≥ ng∆∞·ªùi thu√™ n√†o tr·ªëng</option>}</select></div>
                                <div><label className="block text-sm font-medium text-gray-700">Gi√° thu√™ 1 th√°ng (VNƒê)</label><input type="number" value={contractData.rentPrice} onChange={e => setContractData({...contractData, rentPrice: e.target.value})} className="input-form w-full"/></div>
                                <div><label className="block text-sm font-medium text-gray-700">K·ª≥ thanh to√°n</label><select value={contractData.paymentCycle} onChange={e => setContractData({...contractData, paymentCycle: e.target.value})} className="input-form w-full"><option value="3">3 Th√°ng</option><option value="6">6 Th√°ng</option></select></div>
                                <div className="p-4 bg-blue-50 rounded-lg text-center"><p className="text-gray-600">T·ªïng ti·ªÅn cho k·ª≥ ƒë·∫ßu ti√™n:</p><p className="text-2xl font-bold text-blue-700">{formatCurrency(parseInt(contractData.rentPrice) * parseInt(contractData.paymentCycle))} VNƒê</p></div>
                                
                                <hr/>

                                <button type="button" onClick={handleGenerateContractText} disabled={isGenerating} className="w-full flex justify-center items-center gap-2 btn-secondary bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    {isGenerating ? 'ƒêang so·∫°n th·∫£o...' : 'So·∫°n Th·∫£o Kho·∫£n H·ª£p ƒê·ªìng ‚ú®'}
                                </button>

                                {isGenerating && <div className="text-center p-4 text-purple-700">ƒêang k·∫øt n·ªëi v·ªõi AI, vui l√≤ng ch·ªù...</div>}

                                {generatedContractText && (
                                    <div className="mt-4 p-4 border rounded-lg bg-gray-50">
                                        <h4 className="font-semibold text-lg mb-2">N·ªôi dung h·ª£p ƒë·ªìng g·ª£i √Ω:</h4>
                                        <textarea readOnly className="w-full h-64 p-2 border rounded bg-white font-mono text-sm" value={generatedContractText}></textarea>
                                        <div className="mt-2">
                                            <button type="button" onClick={() => copyToClipboard(generatedContractText)} className="btn-secondary bg-gray-600 hover:bg-gray-700">
                                                Sao ch√©p n·ªôi dung
                                            </button>
                                            {copySuccess && <span className="ml-4 text-green-600 font-semibold">{copySuccess}</span>}
                                        </div>
                                    </div>
                                )}

                                <hr/>

                                <button type="submit" className="btn-primary w-full">X√°c Nh·∫≠n T·∫°o H·ª£p ƒê·ªìng</button>
                            </div>
                        </form>
                    </Modal>
                </div>
            );
        };

        // --- RENDER THE APP TO THE DOM USING REACT 18 API ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
